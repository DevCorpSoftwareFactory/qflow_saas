
> api@0.0.1 test:e2e /home/devin/Projects/qflow-pro/apps/api
> jest --config ./test/jest-e2e.json

FAIL test/auth-complete.e2e-spec.ts (5.122 s)
  ‚óè Console

    console.warn
      No refresh token returned from login, skipping test

      72 |             // Skip if no refresh token was returned
      73 |             if (!refreshToken) {
    > 74 |                 console.warn('No refresh token returned from login, skipping test');
         |                         ^
      75 |                 return;
      76 |             }
      77 |

      at Object.<anonymous> (auth-complete.e2e-spec.ts:74:25)

    console.log
      [Email Mock] Password reset link for sync-test-1768592593611@test.com: https://app.qflow.com/reset-password?token=b37abb03-fd81-458f-8046-9933de122310.f71c7fc222f5411ef7e6d56669b7c622a6adc0ff032684d61b9a51b9a5cfe671

      at AuthService.forgotPassword (../src/auth/auth.service.ts:250:13)

    console.warn
      No refresh token, skipping rotation test

      223 |             // Skip if no refresh token
      224 |             if (!refreshToken) {
    > 225 |                 console.warn('No refresh token, skipping rotation test');
          |                         ^
      226 |                 return;
      227 |             }
      228 |

      at Object.<anonymous> (auth-complete.e2e-spec.ts:225:25)

  ‚óè Auth Complete E2E Tests ‚Ä∫ POST /auth/forgot-password ‚Ä∫ should reject request with invalid email format

    expect(received).toContain(expected) // indexOf

    Expected value: 200
    Received array: [400, 500]

      155 |
      156 |             // 400 = validation error, 500 = database not synced
    > 157 |             expect([400, 500]).toContain(response.status);
          |                                ^
      158 |         });
      159 |
      160 |         it('should reject request with missing email', async () => {

      at Object.<anonymous> (auth-complete.e2e-spec.ts:157:32)

  ‚óè Auth Complete E2E Tests ‚Ä∫ POST /auth/forgot-password ‚Ä∫ should reject request with missing email

    expect(received).toContain(expected) // indexOf

    Expected value: 200
    Received array: [400, 500]

      164 |
      165 |             // 400 = validation error, 500 = database not synced
    > 166 |             expect([400, 500]).toContain(response.status);
          |                                ^
      167 |         });
      168 |     });
      169 |

      at Object.<anonymous> (auth-complete.e2e-spec.ts:166:32)

PASS test/performance.e2e-spec.ts (17.492 s)
  ‚óè Console

    console.log
      Burst completed in 142ms

      at Object.<anonymous> (performance.e2e-spec.ts:81:15)

PASS test/integration.e2e-spec.ts (5.828 s)
  ‚óè Console

    console.log
      [CreateSale] User: {
        userId: '6abb6b6a-a172-43a5-9906-dae4a7b40822',
        tenantId: '4d60b26c-9986-4aca-bc7d-84995a3b55c1',
        email: 'sales-cycle-1768617036699@test.com',
        roleId: 'a29cc787-16b0-43a0-8321-9ae352360d5f',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: 4d60b26c-9986-4aca-bc7d-84995a3b55c1

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"6d7a369a-7caa-451c-bf47-60ffce74d069","cashierId":"ea085763-5cc4-4cb8-9c25-cabce897ae7c","items":[{"variantId":"ecdbd072-620d-4a4b-a30f-a762399bf811","quantity":1,"unitPrice":100}],"paymentMethod":"cash"}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

[31m[Nest] 22165  - [39m16/01/2026, 9:30:44 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to concurrent update
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'677b5998-d229-41af-b95e-746e03bc20c1'[39m,
    [32m'805b2a27-ec7a-4813-bb17-5dcf3914afcd'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to concurrent update
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m114[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'nodeLockRows.c'[39m,
    line: [32m'227'[39m,
    routine: [32m'ExecLockRows'[39m
  },
  length: [33m114[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'nodeLockRows.c'[39m,
  line: [32m'227'[39m,
  routine: [32m'ExecLockRows'[39m
}
[31m[Nest] 22165  - [39m16/01/2026, 9:30:44 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to concurrent update
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'677b5998-d229-41af-b95e-746e03bc20c1'[39m,
    [32m'805b2a27-ec7a-4813-bb17-5dcf3914afcd'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to concurrent update
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m114[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'nodeLockRows.c'[39m,
    line: [32m'227'[39m,
    routine: [32m'ExecLockRows'[39m
  },
  length: [33m114[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'nodeLockRows.c'[39m,
  line: [32m'227'[39m,
  routine: [32m'ExecLockRows'[39m
}
[31m[Nest] 22165  - [39m16/01/2026, 9:30:44 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to read/write dependencies among transactions
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'677b5998-d229-41af-b95e-746e03bc20c1'[39m,
    [32m'805b2a27-ec7a-4813-bb17-5dcf3914afcd'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to read/write dependencies among transactions
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m274[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [32m'Reason code: Canceled on conflict out to pivot 2490, during read.'[39m,
    hint: [32m'The transaction might succeed if retried.'[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'predicate.c'[39m,
    line: [32m'4832'[39m,
    routine: [32m'OnConflict_CheckForSerializationFailure'[39m
  },
  length: [33m274[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [32m'Reason code: Canceled on conflict out to pivot 2490, during read.'[39m,
  hint: [32m'The transaction might succeed if retried.'[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'predicate.c'[39m,
  line: [32m'4832'[39m,
  routine: [32m'OnConflict_CheckForSerializationFailure'[39m
}
[31m[Nest] 22165  - [39m16/01/2026, 9:30:44 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to read/write dependencies among transactions
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'677b5998-d229-41af-b95e-746e03bc20c1'[39m,
    [32m'805b2a27-ec7a-4813-bb17-5dcf3914afcd'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to read/write dependencies among transactions
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m274[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [32m'Reason code: Canceled on conflict out to pivot 2490, during read.'[39m,
    hint: [32m'The transaction might succeed if retried.'[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'predicate.c'[39m,
    line: [32m'4832'[39m,
    routine: [32m'OnConflict_CheckForSerializationFailure'[39m
  },
  length: [33m274[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [32m'Reason code: Canceled on conflict out to pivot 2490, during read.'[39m,
  hint: [32m'The transaction might succeed if retried.'[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'predicate.c'[39m,
  line: [32m'4832'[39m,
  routine: [32m'OnConflict_CheckForSerializationFailure'[39m
}
[31m[Nest] 22165  - [39m16/01/2026, 9:30:44 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to read/write dependencies among transactions
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'677b5998-d229-41af-b95e-746e03bc20c1'[39m,
    [32m'805b2a27-ec7a-4813-bb17-5dcf3914afcd'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to read/write dependencies among transactions
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m274[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [32m'Reason code: Canceled on conflict out to pivot 2490, during read.'[39m,
    hint: [32m'The transaction might succeed if retried.'[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'predicate.c'[39m,
    line: [32m'4832'[39m,
    routine: [32m'OnConflict_CheckForSerializationFailure'[39m
  },
  length: [33m274[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [32m'Reason code: Canceled on conflict out to pivot 2490, during read.'[39m,
  hint: [32m'The transaction might succeed if retried.'[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'predicate.c'[39m,
  line: [32m'4832'[39m,
  routine: [32m'OnConflict_CheckForSerializationFailure'[39m
}
[31m[Nest] 22165  - [39m16/01/2026, 9:30:44 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to read/write dependencies among transactions
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'677b5998-d229-41af-b95e-746e03bc20c1'[39m,
    [32m'805b2a27-ec7a-4813-bb17-5dcf3914afcd'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to read/write dependencies among transactions
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m274[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [32m'Reason code: Canceled on conflict out to pivot 2490, during read.'[39m,
    hint: [32m'The transaction might succeed if retried.'[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'predicate.c'[39m,
    line: [32m'4832'[39m,
    routine: [32m'OnConflict_CheckForSerializationFailure'[39m
  },
  length: [33m274[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [32m'Reason code: Canceled on conflict out to pivot 2490, during read.'[39m,
  hint: [32m'The transaction might succeed if retried.'[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'predicate.c'[39m,
  line: [32m'4832'[39m,
  routine: [32m'OnConflict_CheckForSerializationFailure'[39m
}
[31m[Nest] 22165  - [39m16/01/2026, 9:30:44 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to concurrent update
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'677b5998-d229-41af-b95e-746e03bc20c1'[39m,
    [32m'805b2a27-ec7a-4813-bb17-5dcf3914afcd'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to concurrent update
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m114[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'nodeLockRows.c'[39m,
    line: [32m'227'[39m,
    routine: [32m'ExecLockRows'[39m
  },
  length: [33m114[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'nodeLockRows.c'[39m,
  line: [32m'227'[39m,
  routine: [32m'ExecLockRows'[39m
}
[31m[Nest] 22165  - [39m16/01/2026, 9:30:44 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to concurrent update
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'677b5998-d229-41af-b95e-746e03bc20c1'[39m,
    [32m'805b2a27-ec7a-4813-bb17-5dcf3914afcd'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to concurrent update
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m114[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'nodeLockRows.c'[39m,
    line: [32m'227'[39m,
    routine: [32m'ExecLockRows'[39m
  },
  length: [33m114[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'nodeLockRows.c'[39m,
  line: [32m'227'[39m,
  routine: [32m'ExecLockRows'[39m
}
[31m[Nest] 22165  - [39m16/01/2026, 9:30:45 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to read/write dependencies among transactions
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'677b5998-d229-41af-b95e-746e03bc20c1'[39m,
    [32m'805b2a27-ec7a-4813-bb17-5dcf3914afcd'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to read/write dependencies among transactions
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m274[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [32m'Reason code: Canceled on conflict out to pivot 2504, during read.'[39m,
    hint: [32m'The transaction might succeed if retried.'[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'predicate.c'[39m,
    line: [32m'4832'[39m,
    routine: [32m'OnConflict_CheckForSerializationFailure'[39m
  },
  length: [33m274[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [32m'Reason code: Canceled on conflict out to pivot 2504, during read.'[39m,
  hint: [32m'The transaction might succeed if retried.'[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'predicate.c'[39m,
  line: [32m'4832'[39m,
  routine: [32m'OnConflict_CheckForSerializationFailure'[39m
}
[31m[Nest] 22165  - [39m16/01/2026, 9:30:45 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to concurrent update
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'677b5998-d229-41af-b95e-746e03bc20c1'[39m,
    [32m'805b2a27-ec7a-4813-bb17-5dcf3914afcd'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to concurrent update
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m114[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'nodeLockRows.c'[39m,
    line: [32m'227'[39m,
    routine: [32m'ExecLockRows'[39m
  },
  length: [33m114[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'nodeLockRows.c'[39m,
  line: [32m'227'[39m,
  routine: [32m'ExecLockRows'[39m
}
[31m[Nest] 22165  - [39m16/01/2026, 9:30:45 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to concurrent update
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'677b5998-d229-41af-b95e-746e03bc20c1'[39m,
    [32m'805b2a27-ec7a-4813-bb17-5dcf3914afcd'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to concurrent update
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m114[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'nodeLockRows.c'[39m,
    line: [32m'227'[39m,
    routine: [32m'ExecLockRows'[39m
  },
  length: [33m114[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'nodeLockRows.c'[39m,
  line: [32m'227'[39m,
  routine: [32m'ExecLockRows'[39m
}
[31m[Nest] 22165  - [39m16/01/2026, 9:30:45 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to concurrent update
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'677b5998-d229-41af-b95e-746e03bc20c1'[39m,
    [32m'805b2a27-ec7a-4813-bb17-5dcf3914afcd'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to concurrent update
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m114[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'nodeLockRows.c'[39m,
    line: [32m'227'[39m,
    routine: [32m'ExecLockRows'[39m
  },
  length: [33m114[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'nodeLockRows.c'[39m,
  line: [32m'227'[39m,
  routine: [32m'ExecLockRows'[39m
}
[31m[Nest] 22165  - [39m16/01/2026, 9:30:45 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to concurrent update
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'677b5998-d229-41af-b95e-746e03bc20c1'[39m,
    [32m'805b2a27-ec7a-4813-bb17-5dcf3914afcd'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to concurrent update
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m114[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'nodeLockRows.c'[39m,
    line: [32m'227'[39m,
    routine: [32m'ExecLockRows'[39m
  },
  length: [33m114[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'nodeLockRows.c'[39m,
  line: [32m'227'[39m,
  routine: [32m'ExecLockRows'[39m
}
[31m[Nest] 22165  - [39m16/01/2026, 9:30:45 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to concurrent update
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'677b5998-d229-41af-b95e-746e03bc20c1'[39m,
    [32m'805b2a27-ec7a-4813-bb17-5dcf3914afcd'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to concurrent update
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m114[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'nodeLockRows.c'[39m,
    line: [32m'227'[39m,
    routine: [32m'ExecLockRows'[39m
  },
  length: [33m114[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'nodeLockRows.c'[39m,
  line: [32m'227'[39m,
  routine: [32m'ExecLockRows'[39m
}
[31m[Nest] 22165  - [39m16/01/2026, 9:30:45 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to concurrent update
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'677b5998-d229-41af-b95e-746e03bc20c1'[39m,
    [32m'805b2a27-ec7a-4813-bb17-5dcf3914afcd'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to concurrent update
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m114[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'nodeLockRows.c'[39m,
    line: [32m'227'[39m,
    routine: [32m'ExecLockRows'[39m
  },
  length: [33m114[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'nodeLockRows.c'[39m,
  line: [32m'227'[39m,
  routine: [32m'ExecLockRows'[39m
}
[31m[Nest] 22165  - [39m16/01/2026, 9:30:45 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to concurrent update
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'677b5998-d229-41af-b95e-746e03bc20c1'[39m,
    [32m'805b2a27-ec7a-4813-bb17-5dcf3914afcd'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to concurrent update
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m114[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'nodeLockRows.c'[39m,
    line: [32m'227'[39m,
    routine: [32m'ExecLockRows'[39m
  },
  length: [33m114[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'nodeLockRows.c'[39m,
  line: [32m'227'[39m,
  routine: [32m'ExecLockRows'[39m
}
[31m[Nest] 22165  - [39m16/01/2026, 9:30:45 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to read/write dependencies among transactions
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'677b5998-d229-41af-b95e-746e03bc20c1'[39m,
    [32m'805b2a27-ec7a-4813-bb17-5dcf3914afcd'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to read/write dependencies among transactions
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m274[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [32m'Reason code: Canceled on conflict out to pivot 2504, during read.'[39m,
    hint: [32m'The transaction might succeed if retried.'[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'predicate.c'[39m,
    line: [32m'4832'[39m,
    routine: [32m'OnConflict_CheckForSerializationFailure'[39m
  },
  length: [33m274[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [32m'Reason code: Canceled on conflict out to pivot 2504, during read.'[39m,
  hint: [32m'The transaction might succeed if retried.'[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'predicate.c'[39m,
  line: [32m'4832'[39m,
  routine: [32m'OnConflict_CheckForSerializationFailure'[39m
}
[31m[Nest] 22165  - [39m16/01/2026, 9:30:45 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to concurrent update
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'677b5998-d229-41af-b95e-746e03bc20c1'[39m,
    [32m'805b2a27-ec7a-4813-bb17-5dcf3914afcd'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to concurrent update
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m114[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'nodeLockRows.c'[39m,
    line: [32m'227'[39m,
    routine: [32m'ExecLockRows'[39m
  },
  length: [33m114[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'nodeLockRows.c'[39m,
  line: [32m'227'[39m,
  routine: [32m'ExecLockRows'[39m
}
[31m[Nest] 22165  - [39m16/01/2026, 9:30:45 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to concurrent update
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'677b5998-d229-41af-b95e-746e03bc20c1'[39m,
    [32m'805b2a27-ec7a-4813-bb17-5dcf3914afcd'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to concurrent update
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m114[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'nodeLockRows.c'[39m,
    line: [32m'227'[39m,
    routine: [32m'ExecLockRows'[39m
  },
  length: [33m114[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'nodeLockRows.c'[39m,
  line: [32m'227'[39m,
  routine: [32m'ExecLockRows'[39m
}
[31m[Nest] 22165  - [39m16/01/2026, 9:30:45 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to concurrent update
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'677b5998-d229-41af-b95e-746e03bc20c1'[39m,
    [32m'805b2a27-ec7a-4813-bb17-5dcf3914afcd'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to concurrent update
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m114[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'nodeLockRows.c'[39m,
    line: [32m'227'[39m,
    routine: [32m'ExecLockRows'[39m
  },
  length: [33m114[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'nodeLockRows.c'[39m,
  line: [32m'227'[39m,
  routine: [32m'ExecLockRows'[39m
}
[31m[Nest] 22165  - [39m16/01/2026, 9:30:45 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to concurrent update
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'677b5998-d229-41af-b95e-746e03bc20c1'[39m,
    [32m'805b2a27-ec7a-4813-bb17-5dcf3914afcd'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to concurrent update
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m114[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'nodeLockRows.c'[39m,
    line: [32m'227'[39m,
    routine: [32m'ExecLockRows'[39m
  },
  length: [33m114[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'nodeLockRows.c'[39m,
  line: [32m'227'[39m,
  routine: [32m'ExecLockRows'[39m
}
[31m[Nest] 22165  - [39m16/01/2026, 9:30:45 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to concurrent update
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'677b5998-d229-41af-b95e-746e03bc20c1'[39m,
    [32m'805b2a27-ec7a-4813-bb17-5dcf3914afcd'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to concurrent update
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m114[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'nodeLockRows.c'[39m,
    line: [32m'227'[39m,
    routine: [32m'ExecLockRows'[39m
  },
  length: [33m114[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'nodeLockRows.c'[39m,
  line: [32m'227'[39m,
  routine: [32m'ExecLockRows'[39m
}
[31m[Nest] 22165  - [39m16/01/2026, 9:30:45 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to concurrent update
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'677b5998-d229-41af-b95e-746e03bc20c1'[39m,
    [32m'805b2a27-ec7a-4813-bb17-5dcf3914afcd'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to concurrent update
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m114[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'nodeLockRows.c'[39m,
    line: [32m'227'[39m,
    routine: [32m'ExecLockRows'[39m
  },
  length: [33m114[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'nodeLockRows.c'[39m,
  line: [32m'227'[39m,
  routine: [32m'ExecLockRows'[39m
}
[31m[Nest] 22165  - [39m16/01/2026, 9:30:45 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to concurrent update
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'677b5998-d229-41af-b95e-746e03bc20c1'[39m,
    [32m'805b2a27-ec7a-4813-bb17-5dcf3914afcd'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to concurrent update
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m114[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'nodeLockRows.c'[39m,
    line: [32m'227'[39m,
    routine: [32m'ExecLockRows'[39m
  },
  length: [33m114[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'nodeLockRows.c'[39m,
  line: [32m'227'[39m,
  routine: [32m'ExecLockRows'[39m
}
[31m[Nest] 22165  - [39m16/01/2026, 9:30:45 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to concurrent update
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'677b5998-d229-41af-b95e-746e03bc20c1'[39m,
    [32m'805b2a27-ec7a-4813-bb17-5dcf3914afcd'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to concurrent update
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m114[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'nodeLockRows.c'[39m,
    line: [32m'227'[39m,
    routine: [32m'ExecLockRows'[39m
  },
  length: [33m114[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'nodeLockRows.c'[39m,
  line: [32m'227'[39m,
  routine: [32m'ExecLockRows'[39m
}
[31m[Nest] 22165  - [39m16/01/2026, 9:30:45 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to concurrent update
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'677b5998-d229-41af-b95e-746e03bc20c1'[39m,
    [32m'805b2a27-ec7a-4813-bb17-5dcf3914afcd'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to concurrent update
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m114[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'nodeLockRows.c'[39m,
    line: [32m'227'[39m,
    routine: [32m'ExecLockRows'[39m
  },
  length: [33m114[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'nodeLockRows.c'[39m,
  line: [32m'227'[39m,
  routine: [32m'ExecLockRows'[39m
}
[31m[Nest] 22165  - [39m16/01/2026, 9:30:45 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to concurrent update
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'677b5998-d229-41af-b95e-746e03bc20c1'[39m,
    [32m'805b2a27-ec7a-4813-bb17-5dcf3914afcd'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to concurrent update
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m114[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'nodeLockRows.c'[39m,
    line: [32m'227'[39m,
    routine: [32m'ExecLockRows'[39m
  },
  length: [33m114[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'nodeLockRows.c'[39m,
  line: [32m'227'[39m,
  routine: [32m'ExecLockRows'[39m
}
PASS test/sales-concurrency.e2e-spec.ts
  ‚óè Console

    console.log
      [CreateSale] User: {
        userId: 'c7ca5f0c-7eb3-448a-884d-006308a25f91',
        tenantId: '6b287af0-c9cf-4d50-8476-b71f0ecf9b1b',
        email: 'conc-sales-1768617042543@test.com',
        roleId: '7f569903-8fbf-4d9c-92eb-3deae8c1f530',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: 6b287af0-c9cf-4d50-8476-b71f0ecf9b1b

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"805b2a27-ec7a-4813-bb17-5dcf3914afcd","cashierId":"c7ca5f0c-7eb3-448a-884d-006308a25f91","paymentMethod":"cash","items":[{"variantId":"677b5998-d229-41af-b95e-746e03bc20c1","quantity":1,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'c7ca5f0c-7eb3-448a-884d-006308a25f91',
        tenantId: '6b287af0-c9cf-4d50-8476-b71f0ecf9b1b',
        email: 'conc-sales-1768617042543@test.com',
        roleId: '7f569903-8fbf-4d9c-92eb-3deae8c1f530',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: 6b287af0-c9cf-4d50-8476-b71f0ecf9b1b

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"805b2a27-ec7a-4813-bb17-5dcf3914afcd","cashierId":"c7ca5f0c-7eb3-448a-884d-006308a25f91","paymentMethod":"cash","items":[{"variantId":"677b5998-d229-41af-b95e-746e03bc20c1","quantity":1,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'c7ca5f0c-7eb3-448a-884d-006308a25f91',
        tenantId: '6b287af0-c9cf-4d50-8476-b71f0ecf9b1b',
        email: 'conc-sales-1768617042543@test.com',
        roleId: '7f569903-8fbf-4d9c-92eb-3deae8c1f530',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: 6b287af0-c9cf-4d50-8476-b71f0ecf9b1b

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"805b2a27-ec7a-4813-bb17-5dcf3914afcd","cashierId":"c7ca5f0c-7eb3-448a-884d-006308a25f91","paymentMethod":"cash","items":[{"variantId":"677b5998-d229-41af-b95e-746e03bc20c1","quantity":1,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'c7ca5f0c-7eb3-448a-884d-006308a25f91',
        tenantId: '6b287af0-c9cf-4d50-8476-b71f0ecf9b1b',
        email: 'conc-sales-1768617042543@test.com',
        roleId: '7f569903-8fbf-4d9c-92eb-3deae8c1f530',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: 6b287af0-c9cf-4d50-8476-b71f0ecf9b1b

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"805b2a27-ec7a-4813-bb17-5dcf3914afcd","cashierId":"c7ca5f0c-7eb3-448a-884d-006308a25f91","paymentMethod":"cash","items":[{"variantId":"677b5998-d229-41af-b95e-746e03bc20c1","quantity":1,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'c7ca5f0c-7eb3-448a-884d-006308a25f91',
        tenantId: '6b287af0-c9cf-4d50-8476-b71f0ecf9b1b',
        email: 'conc-sales-1768617042543@test.com',
        roleId: '7f569903-8fbf-4d9c-92eb-3deae8c1f530',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: 6b287af0-c9cf-4d50-8476-b71f0ecf9b1b

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"805b2a27-ec7a-4813-bb17-5dcf3914afcd","cashierId":"c7ca5f0c-7eb3-448a-884d-006308a25f91","paymentMethod":"cash","items":[{"variantId":"677b5998-d229-41af-b95e-746e03bc20c1","quantity":1,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'c7ca5f0c-7eb3-448a-884d-006308a25f91',
        tenantId: '6b287af0-c9cf-4d50-8476-b71f0ecf9b1b',
        email: 'conc-sales-1768617042543@test.com',
        roleId: '7f569903-8fbf-4d9c-92eb-3deae8c1f530',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: 6b287af0-c9cf-4d50-8476-b71f0ecf9b1b

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"805b2a27-ec7a-4813-bb17-5dcf3914afcd","cashierId":"c7ca5f0c-7eb3-448a-884d-006308a25f91","paymentMethod":"cash","items":[{"variantId":"677b5998-d229-41af-b95e-746e03bc20c1","quantity":1,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'c7ca5f0c-7eb3-448a-884d-006308a25f91',
        tenantId: '6b287af0-c9cf-4d50-8476-b71f0ecf9b1b',
        email: 'conc-sales-1768617042543@test.com',
        roleId: '7f569903-8fbf-4d9c-92eb-3deae8c1f530',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: 6b287af0-c9cf-4d50-8476-b71f0ecf9b1b

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"805b2a27-ec7a-4813-bb17-5dcf3914afcd","cashierId":"c7ca5f0c-7eb3-448a-884d-006308a25f91","paymentMethod":"cash","items":[{"variantId":"677b5998-d229-41af-b95e-746e03bc20c1","quantity":1,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'c7ca5f0c-7eb3-448a-884d-006308a25f91',
        tenantId: '6b287af0-c9cf-4d50-8476-b71f0ecf9b1b',
        email: 'conc-sales-1768617042543@test.com',
        roleId: '7f569903-8fbf-4d9c-92eb-3deae8c1f530',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: 6b287af0-c9cf-4d50-8476-b71f0ecf9b1b

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"805b2a27-ec7a-4813-bb17-5dcf3914afcd","cashierId":"c7ca5f0c-7eb3-448a-884d-006308a25f91","paymentMethod":"cash","items":[{"variantId":"677b5998-d229-41af-b95e-746e03bc20c1","quantity":1,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'c7ca5f0c-7eb3-448a-884d-006308a25f91',
        tenantId: '6b287af0-c9cf-4d50-8476-b71f0ecf9b1b',
        email: 'conc-sales-1768617042543@test.com',
        roleId: '7f569903-8fbf-4d9c-92eb-3deae8c1f530',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: 6b287af0-c9cf-4d50-8476-b71f0ecf9b1b

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"805b2a27-ec7a-4813-bb17-5dcf3914afcd","cashierId":"c7ca5f0c-7eb3-448a-884d-006308a25f91","paymentMethod":"cash","items":[{"variantId":"677b5998-d229-41af-b95e-746e03bc20c1","quantity":1,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'c7ca5f0c-7eb3-448a-884d-006308a25f91',
        tenantId: '6b287af0-c9cf-4d50-8476-b71f0ecf9b1b',
        email: 'conc-sales-1768617042543@test.com',
        roleId: '7f569903-8fbf-4d9c-92eb-3deae8c1f530',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: 6b287af0-c9cf-4d50-8476-b71f0ecf9b1b

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"805b2a27-ec7a-4813-bb17-5dcf3914afcd","cashierId":"c7ca5f0c-7eb3-448a-884d-006308a25f91","paymentMethod":"cash","items":[{"variantId":"677b5998-d229-41af-b95e-746e03bc20c1","quantity":1,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["677b5998-d229-41af-b95e-746e03bc20c1","805b2a27-ec7a-4813-bb17-5dcf3914afcd","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to concurrent update

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["677b5998-d229-41af-b95e-746e03bc20c1","805b2a27-ec7a-4813-bb17-5dcf3914afcd","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to concurrent update

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["677b5998-d229-41af-b95e-746e03bc20c1","805b2a27-ec7a-4813-bb17-5dcf3914afcd","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to read/write dependencies among transactions

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["677b5998-d229-41af-b95e-746e03bc20c1","805b2a27-ec7a-4813-bb17-5dcf3914afcd","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to read/write dependencies among transactions

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["677b5998-d229-41af-b95e-746e03bc20c1","805b2a27-ec7a-4813-bb17-5dcf3914afcd","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to read/write dependencies among transactions

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["677b5998-d229-41af-b95e-746e03bc20c1","805b2a27-ec7a-4813-bb17-5dcf3914afcd","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to read/write dependencies among transactions

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["677b5998-d229-41af-b95e-746e03bc20c1","805b2a27-ec7a-4813-bb17-5dcf3914afcd","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to concurrent update

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["677b5998-d229-41af-b95e-746e03bc20c1","805b2a27-ec7a-4813-bb17-5dcf3914afcd","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to concurrent update

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [CreateSale] User: {
        userId: 'c7ca5f0c-7eb3-448a-884d-006308a25f91',
        tenantId: '6b287af0-c9cf-4d50-8476-b71f0ecf9b1b',
        email: 'conc-sales-1768617042543@test.com',
        roleId: '7f569903-8fbf-4d9c-92eb-3deae8c1f530',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: 6b287af0-c9cf-4d50-8476-b71f0ecf9b1b

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"805b2a27-ec7a-4813-bb17-5dcf3914afcd","cashierId":"c7ca5f0c-7eb3-448a-884d-006308a25f91","paymentMethod":"cash","items":[{"variantId":"677b5998-d229-41af-b95e-746e03bc20c1","quantity":2,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'c7ca5f0c-7eb3-448a-884d-006308a25f91',
        tenantId: '6b287af0-c9cf-4d50-8476-b71f0ecf9b1b',
        email: 'conc-sales-1768617042543@test.com',
        roleId: '7f569903-8fbf-4d9c-92eb-3deae8c1f530',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: 6b287af0-c9cf-4d50-8476-b71f0ecf9b1b

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"805b2a27-ec7a-4813-bb17-5dcf3914afcd","cashierId":"c7ca5f0c-7eb3-448a-884d-006308a25f91","paymentMethod":"cash","items":[{"variantId":"677b5998-d229-41af-b95e-746e03bc20c1","quantity":2,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'c7ca5f0c-7eb3-448a-884d-006308a25f91',
        tenantId: '6b287af0-c9cf-4d50-8476-b71f0ecf9b1b',
        email: 'conc-sales-1768617042543@test.com',
        roleId: '7f569903-8fbf-4d9c-92eb-3deae8c1f530',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: 6b287af0-c9cf-4d50-8476-b71f0ecf9b1b

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"805b2a27-ec7a-4813-bb17-5dcf3914afcd","cashierId":"c7ca5f0c-7eb3-448a-884d-006308a25f91","paymentMethod":"cash","items":[{"variantId":"677b5998-d229-41af-b95e-746e03bc20c1","quantity":2,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'c7ca5f0c-7eb3-448a-884d-006308a25f91',
        tenantId: '6b287af0-c9cf-4d50-8476-b71f0ecf9b1b',
        email: 'conc-sales-1768617042543@test.com',
        roleId: '7f569903-8fbf-4d9c-92eb-3deae8c1f530',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: 6b287af0-c9cf-4d50-8476-b71f0ecf9b1b

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"805b2a27-ec7a-4813-bb17-5dcf3914afcd","cashierId":"c7ca5f0c-7eb3-448a-884d-006308a25f91","paymentMethod":"cash","items":[{"variantId":"677b5998-d229-41af-b95e-746e03bc20c1","quantity":2,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'c7ca5f0c-7eb3-448a-884d-006308a25f91',
        tenantId: '6b287af0-c9cf-4d50-8476-b71f0ecf9b1b',
        email: 'conc-sales-1768617042543@test.com',
        roleId: '7f569903-8fbf-4d9c-92eb-3deae8c1f530',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: 6b287af0-c9cf-4d50-8476-b71f0ecf9b1b

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"805b2a27-ec7a-4813-bb17-5dcf3914afcd","cashierId":"c7ca5f0c-7eb3-448a-884d-006308a25f91","paymentMethod":"cash","items":[{"variantId":"677b5998-d229-41af-b95e-746e03bc20c1","quantity":2,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'c7ca5f0c-7eb3-448a-884d-006308a25f91',
        tenantId: '6b287af0-c9cf-4d50-8476-b71f0ecf9b1b',
        email: 'conc-sales-1768617042543@test.com',
        roleId: '7f569903-8fbf-4d9c-92eb-3deae8c1f530',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: 6b287af0-c9cf-4d50-8476-b71f0ecf9b1b

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"805b2a27-ec7a-4813-bb17-5dcf3914afcd","cashierId":"c7ca5f0c-7eb3-448a-884d-006308a25f91","paymentMethod":"cash","items":[{"variantId":"677b5998-d229-41af-b95e-746e03bc20c1","quantity":2,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'c7ca5f0c-7eb3-448a-884d-006308a25f91',
        tenantId: '6b287af0-c9cf-4d50-8476-b71f0ecf9b1b',
        email: 'conc-sales-1768617042543@test.com',
        roleId: '7f569903-8fbf-4d9c-92eb-3deae8c1f530',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: 6b287af0-c9cf-4d50-8476-b71f0ecf9b1b

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"805b2a27-ec7a-4813-bb17-5dcf3914afcd","cashierId":"c7ca5f0c-7eb3-448a-884d-006308a25f91","paymentMethod":"cash","items":[{"variantId":"677b5998-d229-41af-b95e-746e03bc20c1","quantity":2,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'c7ca5f0c-7eb3-448a-884d-006308a25f91',
        tenantId: '6b287af0-c9cf-4d50-8476-b71f0ecf9b1b',
        email: 'conc-sales-1768617042543@test.com',
        roleId: '7f569903-8fbf-4d9c-92eb-3deae8c1f530',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: 6b287af0-c9cf-4d50-8476-b71f0ecf9b1b

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"805b2a27-ec7a-4813-bb17-5dcf3914afcd","cashierId":"c7ca5f0c-7eb3-448a-884d-006308a25f91","paymentMethod":"cash","items":[{"variantId":"677b5998-d229-41af-b95e-746e03bc20c1","quantity":2,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'c7ca5f0c-7eb3-448a-884d-006308a25f91',
        tenantId: '6b287af0-c9cf-4d50-8476-b71f0ecf9b1b',
        email: 'conc-sales-1768617042543@test.com',
        roleId: '7f569903-8fbf-4d9c-92eb-3deae8c1f530',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: 6b287af0-c9cf-4d50-8476-b71f0ecf9b1b

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"805b2a27-ec7a-4813-bb17-5dcf3914afcd","cashierId":"c7ca5f0c-7eb3-448a-884d-006308a25f91","paymentMethod":"cash","items":[{"variantId":"677b5998-d229-41af-b95e-746e03bc20c1","quantity":2,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'c7ca5f0c-7eb3-448a-884d-006308a25f91',
        tenantId: '6b287af0-c9cf-4d50-8476-b71f0ecf9b1b',
        email: 'conc-sales-1768617042543@test.com',
        roleId: '7f569903-8fbf-4d9c-92eb-3deae8c1f530',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: 6b287af0-c9cf-4d50-8476-b71f0ecf9b1b

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"805b2a27-ec7a-4813-bb17-5dcf3914afcd","cashierId":"c7ca5f0c-7eb3-448a-884d-006308a25f91","paymentMethod":"cash","items":[{"variantId":"677b5998-d229-41af-b95e-746e03bc20c1","quantity":2,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'c7ca5f0c-7eb3-448a-884d-006308a25f91',
        tenantId: '6b287af0-c9cf-4d50-8476-b71f0ecf9b1b',
        email: 'conc-sales-1768617042543@test.com',
        roleId: '7f569903-8fbf-4d9c-92eb-3deae8c1f530',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: 6b287af0-c9cf-4d50-8476-b71f0ecf9b1b

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"805b2a27-ec7a-4813-bb17-5dcf3914afcd","cashierId":"c7ca5f0c-7eb3-448a-884d-006308a25f91","paymentMethod":"cash","items":[{"variantId":"677b5998-d229-41af-b95e-746e03bc20c1","quantity":2,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'c7ca5f0c-7eb3-448a-884d-006308a25f91',
        tenantId: '6b287af0-c9cf-4d50-8476-b71f0ecf9b1b',
        email: 'conc-sales-1768617042543@test.com',
        roleId: '7f569903-8fbf-4d9c-92eb-3deae8c1f530',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: 6b287af0-c9cf-4d50-8476-b71f0ecf9b1b

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"805b2a27-ec7a-4813-bb17-5dcf3914afcd","cashierId":"c7ca5f0c-7eb3-448a-884d-006308a25f91","paymentMethod":"cash","items":[{"variantId":"677b5998-d229-41af-b95e-746e03bc20c1","quantity":2,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'c7ca5f0c-7eb3-448a-884d-006308a25f91',
        tenantId: '6b287af0-c9cf-4d50-8476-b71f0ecf9b1b',
        email: 'conc-sales-1768617042543@test.com',
        roleId: '7f569903-8fbf-4d9c-92eb-3deae8c1f530',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: 6b287af0-c9cf-4d50-8476-b71f0ecf9b1b

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"805b2a27-ec7a-4813-bb17-5dcf3914afcd","cashierId":"c7ca5f0c-7eb3-448a-884d-006308a25f91","paymentMethod":"cash","items":[{"variantId":"677b5998-d229-41af-b95e-746e03bc20c1","quantity":2,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'c7ca5f0c-7eb3-448a-884d-006308a25f91',
        tenantId: '6b287af0-c9cf-4d50-8476-b71f0ecf9b1b',
        email: 'conc-sales-1768617042543@test.com',
        roleId: '7f569903-8fbf-4d9c-92eb-3deae8c1f530',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: 6b287af0-c9cf-4d50-8476-b71f0ecf9b1b

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"805b2a27-ec7a-4813-bb17-5dcf3914afcd","cashierId":"c7ca5f0c-7eb3-448a-884d-006308a25f91","paymentMethod":"cash","items":[{"variantId":"677b5998-d229-41af-b95e-746e03bc20c1","quantity":2,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'c7ca5f0c-7eb3-448a-884d-006308a25f91',
        tenantId: '6b287af0-c9cf-4d50-8476-b71f0ecf9b1b',
        email: 'conc-sales-1768617042543@test.com',
        roleId: '7f569903-8fbf-4d9c-92eb-3deae8c1f530',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: 6b287af0-c9cf-4d50-8476-b71f0ecf9b1b

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"805b2a27-ec7a-4813-bb17-5dcf3914afcd","cashierId":"c7ca5f0c-7eb3-448a-884d-006308a25f91","paymentMethod":"cash","items":[{"variantId":"677b5998-d229-41af-b95e-746e03bc20c1","quantity":2,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'c7ca5f0c-7eb3-448a-884d-006308a25f91',
        tenantId: '6b287af0-c9cf-4d50-8476-b71f0ecf9b1b',
        email: 'conc-sales-1768617042543@test.com',
        roleId: '7f569903-8fbf-4d9c-92eb-3deae8c1f530',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: 6b287af0-c9cf-4d50-8476-b71f0ecf9b1b

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"805b2a27-ec7a-4813-bb17-5dcf3914afcd","cashierId":"c7ca5f0c-7eb3-448a-884d-006308a25f91","paymentMethod":"cash","items":[{"variantId":"677b5998-d229-41af-b95e-746e03bc20c1","quantity":2,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["677b5998-d229-41af-b95e-746e03bc20c1","805b2a27-ec7a-4813-bb17-5dcf3914afcd","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to read/write dependencies among transactions

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["677b5998-d229-41af-b95e-746e03bc20c1","805b2a27-ec7a-4813-bb17-5dcf3914afcd","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to concurrent update

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["677b5998-d229-41af-b95e-746e03bc20c1","805b2a27-ec7a-4813-bb17-5dcf3914afcd","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to concurrent update

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["677b5998-d229-41af-b95e-746e03bc20c1","805b2a27-ec7a-4813-bb17-5dcf3914afcd","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to concurrent update

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["677b5998-d229-41af-b95e-746e03bc20c1","805b2a27-ec7a-4813-bb17-5dcf3914afcd","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to concurrent update

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["677b5998-d229-41af-b95e-746e03bc20c1","805b2a27-ec7a-4813-bb17-5dcf3914afcd","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to concurrent update

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["677b5998-d229-41af-b95e-746e03bc20c1","805b2a27-ec7a-4813-bb17-5dcf3914afcd","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to concurrent update

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["677b5998-d229-41af-b95e-746e03bc20c1","805b2a27-ec7a-4813-bb17-5dcf3914afcd","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to concurrent update

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [CreateSale] User: {
        userId: 'c7ca5f0c-7eb3-448a-884d-006308a25f91',
        tenantId: '6b287af0-c9cf-4d50-8476-b71f0ecf9b1b',
        email: 'conc-sales-1768617042543@test.com',
        roleId: '7f569903-8fbf-4d9c-92eb-3deae8c1f530',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: 6b287af0-c9cf-4d50-8476-b71f0ecf9b1b

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"805b2a27-ec7a-4813-bb17-5dcf3914afcd","cashierId":"c7ca5f0c-7eb3-448a-884d-006308a25f91","paymentMethod":"cash","items":[{"variantId":"677b5998-d229-41af-b95e-746e03bc20c1","quantity":2,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["677b5998-d229-41af-b95e-746e03bc20c1","805b2a27-ec7a-4813-bb17-5dcf3914afcd","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to read/write dependencies among transactions

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [CreateSale] User: {
        userId: 'c7ca5f0c-7eb3-448a-884d-006308a25f91',
        tenantId: '6b287af0-c9cf-4d50-8476-b71f0ecf9b1b',
        email: 'conc-sales-1768617042543@test.com',
        roleId: '7f569903-8fbf-4d9c-92eb-3deae8c1f530',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: 6b287af0-c9cf-4d50-8476-b71f0ecf9b1b

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"805b2a27-ec7a-4813-bb17-5dcf3914afcd","cashierId":"c7ca5f0c-7eb3-448a-884d-006308a25f91","paymentMethod":"cash","items":[{"variantId":"677b5998-d229-41af-b95e-746e03bc20c1","quantity":2,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'c7ca5f0c-7eb3-448a-884d-006308a25f91',
        tenantId: '6b287af0-c9cf-4d50-8476-b71f0ecf9b1b',
        email: 'conc-sales-1768617042543@test.com',
        roleId: '7f569903-8fbf-4d9c-92eb-3deae8c1f530',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: 6b287af0-c9cf-4d50-8476-b71f0ecf9b1b

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"805b2a27-ec7a-4813-bb17-5dcf3914afcd","cashierId":"c7ca5f0c-7eb3-448a-884d-006308a25f91","paymentMethod":"cash","items":[{"variantId":"677b5998-d229-41af-b95e-746e03bc20c1","quantity":2,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'c7ca5f0c-7eb3-448a-884d-006308a25f91',
        tenantId: '6b287af0-c9cf-4d50-8476-b71f0ecf9b1b',
        email: 'conc-sales-1768617042543@test.com',
        roleId: '7f569903-8fbf-4d9c-92eb-3deae8c1f530',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: 6b287af0-c9cf-4d50-8476-b71f0ecf9b1b

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"805b2a27-ec7a-4813-bb17-5dcf3914afcd","cashierId":"c7ca5f0c-7eb3-448a-884d-006308a25f91","paymentMethod":"cash","items":[{"variantId":"677b5998-d229-41af-b95e-746e03bc20c1","quantity":2,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'c7ca5f0c-7eb3-448a-884d-006308a25f91',
        tenantId: '6b287af0-c9cf-4d50-8476-b71f0ecf9b1b',
        email: 'conc-sales-1768617042543@test.com',
        roleId: '7f569903-8fbf-4d9c-92eb-3deae8c1f530',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: 6b287af0-c9cf-4d50-8476-b71f0ecf9b1b

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"805b2a27-ec7a-4813-bb17-5dcf3914afcd","cashierId":"c7ca5f0c-7eb3-448a-884d-006308a25f91","paymentMethod":"cash","items":[{"variantId":"677b5998-d229-41af-b95e-746e03bc20c1","quantity":2,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["677b5998-d229-41af-b95e-746e03bc20c1","805b2a27-ec7a-4813-bb17-5dcf3914afcd","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to concurrent update

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["677b5998-d229-41af-b95e-746e03bc20c1","805b2a27-ec7a-4813-bb17-5dcf3914afcd","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to concurrent update

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["677b5998-d229-41af-b95e-746e03bc20c1","805b2a27-ec7a-4813-bb17-5dcf3914afcd","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to concurrent update

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["677b5998-d229-41af-b95e-746e03bc20c1","805b2a27-ec7a-4813-bb17-5dcf3914afcd","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to concurrent update

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["677b5998-d229-41af-b95e-746e03bc20c1","805b2a27-ec7a-4813-bb17-5dcf3914afcd","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to concurrent update

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["677b5998-d229-41af-b95e-746e03bc20c1","805b2a27-ec7a-4813-bb17-5dcf3914afcd","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to concurrent update

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["677b5998-d229-41af-b95e-746e03bc20c1","805b2a27-ec7a-4813-bb17-5dcf3914afcd","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to concurrent update

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["677b5998-d229-41af-b95e-746e03bc20c1","805b2a27-ec7a-4813-bb17-5dcf3914afcd","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to concurrent update

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["677b5998-d229-41af-b95e-746e03bc20c1","805b2a27-ec7a-4813-bb17-5dcf3914afcd","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to concurrent update

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [CreateSale] User: {
        userId: 'c7ca5f0c-7eb3-448a-884d-006308a25f91',
        tenantId: '6b287af0-c9cf-4d50-8476-b71f0ecf9b1b',
        email: 'conc-sales-1768617042543@test.com',
        roleId: '7f569903-8fbf-4d9c-92eb-3deae8c1f530',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: 6b287af0-c9cf-4d50-8476-b71f0ecf9b1b

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"805b2a27-ec7a-4813-bb17-5dcf3914afcd","cashierId":"c7ca5f0c-7eb3-448a-884d-006308a25f91","paymentMethod":"cash","items":[{"variantId":"677b5998-d229-41af-b95e-746e03bc20c1","quantity":1,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'c7ca5f0c-7eb3-448a-884d-006308a25f91',
        tenantId: '6b287af0-c9cf-4d50-8476-b71f0ecf9b1b',
        email: 'conc-sales-1768617042543@test.com',
        roleId: '7f569903-8fbf-4d9c-92eb-3deae8c1f530',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: 6b287af0-c9cf-4d50-8476-b71f0ecf9b1b

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"805b2a27-ec7a-4813-bb17-5dcf3914afcd","cashierId":"c7ca5f0c-7eb3-448a-884d-006308a25f91","paymentMethod":"cash","items":[{"variantId":"677b5998-d229-41af-b95e-746e03bc20c1","quantity":1,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["677b5998-d229-41af-b95e-746e03bc20c1","805b2a27-ec7a-4813-bb17-5dcf3914afcd","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to concurrent update

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [CreateSale] User: {
        userId: 'c7ca5f0c-7eb3-448a-884d-006308a25f91',
        tenantId: '6b287af0-c9cf-4d50-8476-b71f0ecf9b1b',
        email: 'conc-sales-1768617042543@test.com',
        roleId: '7f569903-8fbf-4d9c-92eb-3deae8c1f530',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: 6b287af0-c9cf-4d50-8476-b71f0ecf9b1b

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"805b2a27-ec7a-4813-bb17-5dcf3914afcd","cashierId":"c7ca5f0c-7eb3-448a-884d-006308a25f91","paymentMethod":"cash","items":[{"variantId":"677b5998-d229-41af-b95e-746e03bc20c1","quantity":3,"unitPrice":100},{"variantId":"99999999-9999-9999-9999-999999999999","quantity":1,"unitPrice":50}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'c7ca5f0c-7eb3-448a-884d-006308a25f91',
        tenantId: '6b287af0-c9cf-4d50-8476-b71f0ecf9b1b',
        email: 'conc-sales-1768617042543@test.com',
        roleId: '7f569903-8fbf-4d9c-92eb-3deae8c1f530',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: 6b287af0-c9cf-4d50-8476-b71f0ecf9b1b

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"805b2a27-ec7a-4813-bb17-5dcf3914afcd","cashierId":"c7ca5f0c-7eb3-448a-884d-006308a25f91","paymentMethod":"cash","items":[{"variantId":"677b5998-d229-41af-b95e-746e03bc20c1","quantity":999999,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'c7ca5f0c-7eb3-448a-884d-006308a25f91',
        tenantId: '6b287af0-c9cf-4d50-8476-b71f0ecf9b1b',
        email: 'conc-sales-1768617042543@test.com',
        roleId: '7f569903-8fbf-4d9c-92eb-3deae8c1f530',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: 6b287af0-c9cf-4d50-8476-b71f0ecf9b1b

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"805b2a27-ec7a-4813-bb17-5dcf3914afcd","cashierId":"c7ca5f0c-7eb3-448a-884d-006308a25f91","paymentMethod":"cash","items":[{"variantId":"677b5998-d229-41af-b95e-746e03bc20c1","quantity":3,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

PASS test/catalog.e2e-spec.ts
PASS test/stock-validation.e2e-spec.ts
  ‚óè Console

    console.log
      [CreateSale] User: {
        userId: 'dda969f6-a706-4aa6-b125-009374419f01',
        tenantId: 'f4ecc352-400c-49d3-8ab9-e75dae8e740e',
        email: 'stock-user-1768617049996@test.com',
        roleId: 'b84898c2-c8fb-48d8-b56a-750876a75126',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: f4ecc352-400c-49d3-8ab9-e75dae8e740e

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"d2a797a7-f284-4a9e-aede-5c52f59b374e","cashierId":"dda969f6-a706-4aa6-b125-009374419f01","items":[{"variantId":"815c9575-e207-454e-a7f3-9d261d7e473e","quantity":5,"unitPrice":100}],"paymentMethod":"cash"}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'dda969f6-a706-4aa6-b125-009374419f01',
        tenantId: 'f4ecc352-400c-49d3-8ab9-e75dae8e740e',
        email: 'stock-user-1768617049996@test.com',
        roleId: 'b84898c2-c8fb-48d8-b56a-750876a75126',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: f4ecc352-400c-49d3-8ab9-e75dae8e740e

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"d2a797a7-f284-4a9e-aede-5c52f59b374e","cashierId":"dda969f6-a706-4aa6-b125-009374419f01","items":[{"variantId":"815c9575-e207-454e-a7f3-9d261d7e473e","quantity":3,"unitPrice":100}],"paymentMethod":"cash"}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

PASS test/cash-session.e2e-spec.ts
PASS test/sales.e2e-spec.ts
  ‚óè Console

    console.log
      [CreateSale] User: {
        userId: '62fc32af-0ce9-4719-8ad8-72d000239e3d',
        tenantId: '64b1af18-5035-4971-bb38-c2716ede1515',
        email: 'sales-test-1768617057148@test.com',
        roleId: '81dd4aa7-618b-485e-b86b-87a711126729',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: 64b1af18-5035-4971-bb38-c2716ede1515

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"01f4701d-cf68-47bc-8bdc-d0b8716f4dfa","cashierId":"62fc32af-0ce9-4719-8ad8-72d000239e3d","items":[{"variantId":"fda8e33f-d54d-46a1-be26-adf7236db1b5","quantity":2,"unitPrice":10000}],"paymentMethod":"cash","discountAmount":0}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: '62fc32af-0ce9-4719-8ad8-72d000239e3d',
        tenantId: '64b1af18-5035-4971-bb38-c2716ede1515',
        email: 'sales-test-1768617057148@test.com',
        roleId: '81dd4aa7-618b-485e-b86b-87a711126729',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: 64b1af18-5035-4971-bb38-c2716ede1515

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"01f4701d-cf68-47bc-8bdc-d0b8716f4dfa","cashierId":"62fc32af-0ce9-4719-8ad8-72d000239e3d","items":[{"variantId":"fda8e33f-d54d-46a1-be26-adf7236db1b5","quantity":10000,"unitPrice":10000}],"paymentMethod":"cash","discountAmount":0}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: '62fc32af-0ce9-4719-8ad8-72d000239e3d',
        tenantId: '64b1af18-5035-4971-bb38-c2716ede1515',
        email: 'sales-test-1768617057148@test.com',
        roleId: '81dd4aa7-618b-485e-b86b-87a711126729',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: 64b1af18-5035-4971-bb38-c2716ede1515

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"01f4701d-cf68-47bc-8bdc-d0b8716f4dfa","cashierId":"62fc32af-0ce9-4719-8ad8-72d000239e3d","items":[{"variantId":"62d77a17-c098-4fd8-9db1-e64cb6bbe14e","quantity":1,"unitPrice":10000}],"paymentMethod":"cash","discountAmount":0}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: '62fc32af-0ce9-4719-8ad8-72d000239e3d',
        tenantId: '64b1af18-5035-4971-bb38-c2716ede1515',
        email: 'sales-test-1768617057148@test.com',
        roleId: '81dd4aa7-618b-485e-b86b-87a711126729',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: 64b1af18-5035-4971-bb38-c2716ede1515

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"01f4701d-cf68-47bc-8bdc-d0b8716f4dfa","cashierId":"62fc32af-0ce9-4719-8ad8-72d000239e3d","items":[{"variantId":"fda8e33f-d54d-46a1-be26-adf7236db1b5","quantity":1,"unitPrice":10000,"discountPercent":10}],"paymentMethod":"cash","discountAmount":1000}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

[31m[Nest] 22165  - [39m16/01/2026, 9:31:02 p.¬†m. [31m  ERROR[39m [38;5;3m[SyncService] [39m[31mFailed to sync cash session 113c8fe3-ee81-4e73-a405-dcd50722f939[39m
[31m[Nest] 22165  - [39m16/01/2026, 9:31:02 p.¬†m. [31m  ERROR[39m [38;5;3m[SyncService] [39mQueryFailedError: insert or update on table "cash_sessions" violates foreign key constraint "cash_sessions_cash_register_id_fkey"
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at InsertQueryBuilder.execute (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/InsertQueryBuilder.ts:164:33)
    at SubjectExecutor.executeInsertOperations (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/persistence/SubjectExecutor.ts:435:42)
    at SubjectExecutor.execute (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/persistence/SubjectExecutor.ts:137:9)
    at EntityPersistExecutor.execute (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/persistence/EntityPersistExecutor.ts:182:21)
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sync/sync.service.ts:162:17
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SyncService.processOfflineCashSession [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sync/sync.service.ts:120:9[90m)[39m
    at SyncService.pushBatch [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sync/sync.service.ts:45:21[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'INSERT INTO "cash_sessions"("id", "tenant_id", "cash_register_id", "user_id", "opening_date", "closing_date", "initial_amount", "system_amount", "declared_amount", "difference_justification", "status", "approved_by", "approved_at", "approval_notes", "created_at", "updated_at") VALUES ($1, $2, $3, $4, $5, DEFAULT, $6, $7, DEFAULT, DEFAULT, $8, DEFAULT, DEFAULT, DEFAULT, $9, $10) RETURNING "id", "opening_date", "initial_amount", "system_amount", "status", "created_at", "updated_at"'[39m,
  parameters: [
    [32m'113c8fe3-ee81-4e73-a405-dcd50722f939'[39m,
    [32m'7e55f391-4bc5-45da-8f64-b363f77f80ac'[39m,
    [32m'c0e7ec56-f722-4385-aa5e-82aa1f28b367'[39m,
    [32m'45f914c2-6559-4aec-8a7f-81e6c6bbcc93'[39m,
    [35m2026-01-17T02:31:02.336Z[39m,
    [33m10000[39m,
    [33m10000[39m,
    [32m'open'[39m,
    [35m2026-01-17T02:31:02.336Z[39m,
    [35m2026-01-17T02:31:02.336Z[39m
  ],
  driverError: error: insert or update on table "cash_sessions" violates foreign key constraint "cash_sessions_cash_register_id_fkey"
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at InsertQueryBuilder.execute (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/InsertQueryBuilder.ts:164:33)
      at SubjectExecutor.executeInsertOperations (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/persistence/SubjectExecutor.ts:435:42)
      at SubjectExecutor.execute (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/persistence/SubjectExecutor.ts:137:9)
      at EntityPersistExecutor.execute (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/persistence/EntityPersistExecutor.ts:182:21)
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sync/sync.service.ts:162:17
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SyncService.processOfflineCashSession [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sync/sync.service.ts:120:9[90m)[39m
      at SyncService.pushBatch [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sync/sync.service.ts:45:21[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m345[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23503'[39m,
    detail: [32m'Key (cash_register_id)=(c0e7ec56-f722-4385-aa5e-82aa1f28b367) is not present in table "cash_registers".'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'public'[39m,
    table: [32m'cash_sessions'[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [32m'cash_sessions_cash_register_id_fkey'[39m,
    file: [32m'ri_triggers.c'[39m,
    line: [32m'2596'[39m,
    routine: [32m'ri_ReportViolation'[39m
  },
  length: [33m345[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'23503'[39m,
  detail: [32m'Key (cash_register_id)=(c0e7ec56-f722-4385-aa5e-82aa1f28b367) is not present in table "cash_registers".'[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [32m'public'[39m,
  table: [32m'cash_sessions'[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [32m'cash_sessions_cash_register_id_fkey'[39m,
  file: [32m'ri_triggers.c'[39m,
  line: [32m'2596'[39m,
  routine: [32m'ri_ReportViolation'[39m
}
PASS test/sync-batch.e2e-spec.ts
  ‚óè Console

    console.log
      [4m[31mquery failed:[39m[24m [94mINSERT INTO[0m [37m"cash_sessions"[0m[37m([0m[37m"id"[0m[37m,[0m [37m"tenant_id"[0m[37m,[0m [37m"cash_register_id"[0m[37m,[0m [37m"user_id"[0m[37m,[0m [37m"opening_date"[0m[37m,[0m [37m"closing_date"[0m[37m,[0m [37m"initial_amount"[0m[37m,[0m [37m"system_amount"[0m[37m,[0m [37m"declared_amount"[0m[37m,[0m [37m"difference_justification"[0m[37m,[0m [37m"status"[0m[37m,[0m [37m"approved_by"[0m[37m,[0m [37m"approved_at"[0m[37m,[0m [37m"approval_notes"[0m[37m,[0m [37m"created_at"[0m[37m,[0m [37m"updated_at"[0m[37m)[0m [94mVALUES[0m [37m([0m[37m$[0m[32m1[0m[37m,[0m [37m$[0m[32m2[0m[37m,[0m [37m$[0m[32m3[0m[37m,[0m [37m$[0m[32m4[0m[37m,[0m [37m$[0m[32m5[0m[37m,[0m [94mDEFAULT[0m[37m,[0m [37m$[0m[32m6[0m[37m,[0m [37m$[0m[32m7[0m[37m,[0m [94mDEFAULT[0m[37m,[0m [94mDEFAULT[0m[37m,[0m [37m$[0m[32m8[0m[37m,[0m [94mDEFAULT[0m[37m,[0m [94mDEFAULT[0m[37m,[0m [94mDEFAULT[0m[37m,[0m [37m$[0m[32m9[0m[37m,[0m [37m$[0m[32m10[0m[37m)[0m [94mRETURNING[0m [37m"id"[0m[37m,[0m [37m"opening_date"[0m[37m,[0m [37m"initial_amount"[0m[37m,[0m [37m"system_amount"[0m[37m,[0m [37m"status"[0m[37m,[0m [37m"created_at"[0m[37m,[0m [37m"updated_at"[0m [90m-- PARAMETERS: ["113c8fe3-ee81-4e73-a405-dcd50722f939","7e55f391-4bc5-45da-8f64-b363f77f80ac","c0e7ec56-f722-4385-aa5e-82aa1f28b367","45f914c2-6559-4aec-8a7f-81e6c6bbcc93","2026-01-17T02:31:02.336Z",10000,10000,"open","2026-01-17T02:31:02.336Z","2026-01-17T02:31:02.336Z"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: insert or update on table "cash_sessions" violates foreign key constraint "cash_sessions_cash_register_id_fkey"

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

PASS test/auth-security.e2e-spec.ts
PASS test/app.e2e-spec.ts
PASS test/inventory.e2e-spec.ts

Test Suites: 1 failed, 11 passed, 12 total
Tests:       2 failed, 86 passed, 88 total
Snapshots:   0 total
Time:        54.28 s
Ran all test suites.
Jest did not exit one second after the test run has completed.

'This usually means that there are asynchronous operations that weren't stopped in your tests. Consider running Jest with `--detectOpenHandles` to troubleshoot this issue.
/home/devin/Projects/qflow-pro/apps/api:
‚ÄâERR_PNPM_RECURSIVE_RUN_FIRST_FAIL‚Äâ api@0.0.1 test:e2e: `jest --config ./test/jest-e2e.json`
Exit status 1
