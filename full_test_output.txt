
> api@0.0.1 test:e2e /home/devin/Projects/qflow-pro/apps/api
> jest --config ./test/jest-e2e.json

PASS test/performance.e2e-spec.ts (20.325 s)
  ‚óè Console

    console.log
      Burst completed in 100ms

      at Object.<anonymous> (performance.e2e-spec.ts:81:15)

PASS test/integration.e2e-spec.ts (5.213 s)
  ‚óè Console

    console.log
      [CreateSale] User: {
        userId: '9e525ac5-1c33-4b9c-bfdd-873f5df8c908',
        tenantId: '5f34a5bb-d73c-4970-8f14-98c8e6f2a1a4',
        email: 'sales-cycle-1768617754347@test.com',
        roleId: '53b0657f-5084-41a8-bb42-406e50e06ec7',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: 5f34a5bb-d73c-4970-8f14-98c8e6f2a1a4

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"d8d95dc0-8bba-4e04-be2d-e29bc192bc06","cashierId":"14c9e0ff-88cb-4708-85cc-d73d699bf110","items":[{"variantId":"98c05601-cbdf-4104-81ec-76840df83bc9","quantity":1,"unitPrice":100}],"paymentMethod":"cash"}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

PASS test/auth-complete.e2e-spec.ts
  ‚óè Console

    console.warn
      No refresh token returned from login, skipping test

      72 |             // Skip if no refresh token was returned
      73 |             if (!refreshToken) {
    > 74 |                 console.warn('No refresh token returned from login, skipping test');
         |                         ^
      75 |                 return;
      76 |             }
      77 |

      at Object.<anonymous> (auth-complete.e2e-spec.ts:74:25)

    console.warn
      No refresh token, skipping rotation test

      223 |             // Skip if no refresh token
      224 |             if (!refreshToken) {
    > 225 |                 console.warn('No refresh token, skipping rotation test');
          |                         ^
      226 |                 return;
      227 |             }
      228 |

      at Object.<anonymous> (auth-complete.e2e-spec.ts:225:25)

PASS test/cash-session.e2e-spec.ts
[31m[Nest] 28082  - [39m16/01/2026, 9:42:44 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to read/write dependencies among transactions
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'df4f8f52-3261-4b18-b5b3-8094dd0ee34f'[39m,
    [32m'456e89a4-45c4-4407-9953-38c1adafcf82'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to read/write dependencies among transactions
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m274[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [32m'Reason code: Canceled on conflict out to pivot 2662, during read.'[39m,
    hint: [32m'The transaction might succeed if retried.'[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'predicate.c'[39m,
    line: [32m'4832'[39m,
    routine: [32m'OnConflict_CheckForSerializationFailure'[39m
  },
  length: [33m274[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [32m'Reason code: Canceled on conflict out to pivot 2662, during read.'[39m,
  hint: [32m'The transaction might succeed if retried.'[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'predicate.c'[39m,
  line: [32m'4832'[39m,
  routine: [32m'OnConflict_CheckForSerializationFailure'[39m
}
[31m[Nest] 28082  - [39m16/01/2026, 9:42:44 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to concurrent update
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'df4f8f52-3261-4b18-b5b3-8094dd0ee34f'[39m,
    [32m'456e89a4-45c4-4407-9953-38c1adafcf82'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to concurrent update
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m114[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'nodeLockRows.c'[39m,
    line: [32m'227'[39m,
    routine: [32m'ExecLockRows'[39m
  },
  length: [33m114[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'nodeLockRows.c'[39m,
  line: [32m'227'[39m,
  routine: [32m'ExecLockRows'[39m
}
[31m[Nest] 28082  - [39m16/01/2026, 9:42:44 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to read/write dependencies among transactions
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'df4f8f52-3261-4b18-b5b3-8094dd0ee34f'[39m,
    [32m'456e89a4-45c4-4407-9953-38c1adafcf82'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to read/write dependencies among transactions
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m274[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [32m'Reason code: Canceled on conflict out to pivot 2662, during read.'[39m,
    hint: [32m'The transaction might succeed if retried.'[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'predicate.c'[39m,
    line: [32m'4832'[39m,
    routine: [32m'OnConflict_CheckForSerializationFailure'[39m
  },
  length: [33m274[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [32m'Reason code: Canceled on conflict out to pivot 2662, during read.'[39m,
  hint: [32m'The transaction might succeed if retried.'[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'predicate.c'[39m,
  line: [32m'4832'[39m,
  routine: [32m'OnConflict_CheckForSerializationFailure'[39m
}
[31m[Nest] 28082  - [39m16/01/2026, 9:42:44 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to read/write dependencies among transactions
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'df4f8f52-3261-4b18-b5b3-8094dd0ee34f'[39m,
    [32m'456e89a4-45c4-4407-9953-38c1adafcf82'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to read/write dependencies among transactions
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m274[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [32m'Reason code: Canceled on conflict out to pivot 2662, during read.'[39m,
    hint: [32m'The transaction might succeed if retried.'[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'predicate.c'[39m,
    line: [32m'4832'[39m,
    routine: [32m'OnConflict_CheckForSerializationFailure'[39m
  },
  length: [33m274[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [32m'Reason code: Canceled on conflict out to pivot 2662, during read.'[39m,
  hint: [32m'The transaction might succeed if retried.'[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'predicate.c'[39m,
  line: [32m'4832'[39m,
  routine: [32m'OnConflict_CheckForSerializationFailure'[39m
}
[31m[Nest] 28082  - [39m16/01/2026, 9:42:44 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to read/write dependencies among transactions
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'df4f8f52-3261-4b18-b5b3-8094dd0ee34f'[39m,
    [32m'456e89a4-45c4-4407-9953-38c1adafcf82'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to read/write dependencies among transactions
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m274[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [32m'Reason code: Canceled on conflict out to pivot 2662, during read.'[39m,
    hint: [32m'The transaction might succeed if retried.'[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'predicate.c'[39m,
    line: [32m'4832'[39m,
    routine: [32m'OnConflict_CheckForSerializationFailure'[39m
  },
  length: [33m274[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [32m'Reason code: Canceled on conflict out to pivot 2662, during read.'[39m,
  hint: [32m'The transaction might succeed if retried.'[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'predicate.c'[39m,
  line: [32m'4832'[39m,
  routine: [32m'OnConflict_CheckForSerializationFailure'[39m
}
[31m[Nest] 28082  - [39m16/01/2026, 9:42:44 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to read/write dependencies among transactions
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'df4f8f52-3261-4b18-b5b3-8094dd0ee34f'[39m,
    [32m'456e89a4-45c4-4407-9953-38c1adafcf82'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to read/write dependencies among transactions
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m274[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [32m'Reason code: Canceled on conflict out to pivot 2662, during read.'[39m,
    hint: [32m'The transaction might succeed if retried.'[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'predicate.c'[39m,
    line: [32m'4832'[39m,
    routine: [32m'OnConflict_CheckForSerializationFailure'[39m
  },
  length: [33m274[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [32m'Reason code: Canceled on conflict out to pivot 2662, during read.'[39m,
  hint: [32m'The transaction might succeed if retried.'[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'predicate.c'[39m,
  line: [32m'4832'[39m,
  routine: [32m'OnConflict_CheckForSerializationFailure'[39m
}
[31m[Nest] 28082  - [39m16/01/2026, 9:42:44 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to read/write dependencies among transactions
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'df4f8f52-3261-4b18-b5b3-8094dd0ee34f'[39m,
    [32m'456e89a4-45c4-4407-9953-38c1adafcf82'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to read/write dependencies among transactions
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m274[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [32m'Reason code: Canceled on conflict out to pivot 2662, during read.'[39m,
    hint: [32m'The transaction might succeed if retried.'[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'predicate.c'[39m,
    line: [32m'4832'[39m,
    routine: [32m'OnConflict_CheckForSerializationFailure'[39m
  },
  length: [33m274[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [32m'Reason code: Canceled on conflict out to pivot 2662, during read.'[39m,
  hint: [32m'The transaction might succeed if retried.'[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'predicate.c'[39m,
  line: [32m'4832'[39m,
  routine: [32m'OnConflict_CheckForSerializationFailure'[39m
}
[31m[Nest] 28082  - [39m16/01/2026, 9:42:44 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to read/write dependencies among transactions
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'df4f8f52-3261-4b18-b5b3-8094dd0ee34f'[39m,
    [32m'456e89a4-45c4-4407-9953-38c1adafcf82'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to read/write dependencies among transactions
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m274[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [32m'Reason code: Canceled on conflict out to pivot 2662, during read.'[39m,
    hint: [32m'The transaction might succeed if retried.'[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'predicate.c'[39m,
    line: [32m'4832'[39m,
    routine: [32m'OnConflict_CheckForSerializationFailure'[39m
  },
  length: [33m274[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [32m'Reason code: Canceled on conflict out to pivot 2662, during read.'[39m,
  hint: [32m'The transaction might succeed if retried.'[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'predicate.c'[39m,
  line: [32m'4832'[39m,
  routine: [32m'OnConflict_CheckForSerializationFailure'[39m
}
[31m[Nest] 28082  - [39m16/01/2026, 9:42:44 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to read/write dependencies among transactions
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'df4f8f52-3261-4b18-b5b3-8094dd0ee34f'[39m,
    [32m'456e89a4-45c4-4407-9953-38c1adafcf82'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to read/write dependencies among transactions
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m274[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [32m'Reason code: Canceled on conflict out to pivot 2662, during read.'[39m,
    hint: [32m'The transaction might succeed if retried.'[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'predicate.c'[39m,
    line: [32m'4832'[39m,
    routine: [32m'OnConflict_CheckForSerializationFailure'[39m
  },
  length: [33m274[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [32m'Reason code: Canceled on conflict out to pivot 2662, during read.'[39m,
  hint: [32m'The transaction might succeed if retried.'[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'predicate.c'[39m,
  line: [32m'4832'[39m,
  routine: [32m'OnConflict_CheckForSerializationFailure'[39m
}
[31m[Nest] 28082  - [39m16/01/2026, 9:42:44 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to read/write dependencies among transactions
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'df4f8f52-3261-4b18-b5b3-8094dd0ee34f'[39m,
    [32m'456e89a4-45c4-4407-9953-38c1adafcf82'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to read/write dependencies among transactions
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m274[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [32m'Reason code: Canceled on conflict out to pivot 2676, during read.'[39m,
    hint: [32m'The transaction might succeed if retried.'[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'predicate.c'[39m,
    line: [32m'4832'[39m,
    routine: [32m'OnConflict_CheckForSerializationFailure'[39m
  },
  length: [33m274[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [32m'Reason code: Canceled on conflict out to pivot 2676, during read.'[39m,
  hint: [32m'The transaction might succeed if retried.'[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'predicate.c'[39m,
  line: [32m'4832'[39m,
  routine: [32m'OnConflict_CheckForSerializationFailure'[39m
}
[31m[Nest] 28082  - [39m16/01/2026, 9:42:44 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to concurrent update
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'df4f8f52-3261-4b18-b5b3-8094dd0ee34f'[39m,
    [32m'456e89a4-45c4-4407-9953-38c1adafcf82'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to concurrent update
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m114[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'nodeLockRows.c'[39m,
    line: [32m'227'[39m,
    routine: [32m'ExecLockRows'[39m
  },
  length: [33m114[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'nodeLockRows.c'[39m,
  line: [32m'227'[39m,
  routine: [32m'ExecLockRows'[39m
}
[31m[Nest] 28082  - [39m16/01/2026, 9:42:44 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to concurrent update
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'df4f8f52-3261-4b18-b5b3-8094dd0ee34f'[39m,
    [32m'456e89a4-45c4-4407-9953-38c1adafcf82'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to concurrent update
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m114[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'nodeLockRows.c'[39m,
    line: [32m'227'[39m,
    routine: [32m'ExecLockRows'[39m
  },
  length: [33m114[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'nodeLockRows.c'[39m,
  line: [32m'227'[39m,
  routine: [32m'ExecLockRows'[39m
}
[31m[Nest] 28082  - [39m16/01/2026, 9:42:44 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to concurrent update
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'df4f8f52-3261-4b18-b5b3-8094dd0ee34f'[39m,
    [32m'456e89a4-45c4-4407-9953-38c1adafcf82'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to concurrent update
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m114[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'nodeLockRows.c'[39m,
    line: [32m'227'[39m,
    routine: [32m'ExecLockRows'[39m
  },
  length: [33m114[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'nodeLockRows.c'[39m,
  line: [32m'227'[39m,
  routine: [32m'ExecLockRows'[39m
}
[31m[Nest] 28082  - [39m16/01/2026, 9:42:44 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to concurrent update
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'df4f8f52-3261-4b18-b5b3-8094dd0ee34f'[39m,
    [32m'456e89a4-45c4-4407-9953-38c1adafcf82'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to concurrent update
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m114[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'nodeLockRows.c'[39m,
    line: [32m'227'[39m,
    routine: [32m'ExecLockRows'[39m
  },
  length: [33m114[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'nodeLockRows.c'[39m,
  line: [32m'227'[39m,
  routine: [32m'ExecLockRows'[39m
}
[31m[Nest] 28082  - [39m16/01/2026, 9:42:44 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to concurrent update
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'df4f8f52-3261-4b18-b5b3-8094dd0ee34f'[39m,
    [32m'456e89a4-45c4-4407-9953-38c1adafcf82'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to concurrent update
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m114[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'nodeLockRows.c'[39m,
    line: [32m'227'[39m,
    routine: [32m'ExecLockRows'[39m
  },
  length: [33m114[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'nodeLockRows.c'[39m,
  line: [32m'227'[39m,
  routine: [32m'ExecLockRows'[39m
}
[31m[Nest] 28082  - [39m16/01/2026, 9:42:44 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to concurrent update
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'df4f8f52-3261-4b18-b5b3-8094dd0ee34f'[39m,
    [32m'456e89a4-45c4-4407-9953-38c1adafcf82'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to concurrent update
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m114[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'nodeLockRows.c'[39m,
    line: [32m'227'[39m,
    routine: [32m'ExecLockRows'[39m
  },
  length: [33m114[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'nodeLockRows.c'[39m,
  line: [32m'227'[39m,
  routine: [32m'ExecLockRows'[39m
}
[31m[Nest] 28082  - [39m16/01/2026, 9:42:44 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to concurrent update
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'df4f8f52-3261-4b18-b5b3-8094dd0ee34f'[39m,
    [32m'456e89a4-45c4-4407-9953-38c1adafcf82'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to concurrent update
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m114[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'nodeLockRows.c'[39m,
    line: [32m'227'[39m,
    routine: [32m'ExecLockRows'[39m
  },
  length: [33m114[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'nodeLockRows.c'[39m,
  line: [32m'227'[39m,
  routine: [32m'ExecLockRows'[39m
}
[31m[Nest] 28082  - [39m16/01/2026, 9:42:44 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to read/write dependencies among transactions
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'df4f8f52-3261-4b18-b5b3-8094dd0ee34f'[39m,
    [32m'456e89a4-45c4-4407-9953-38c1adafcf82'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to read/write dependencies among transactions
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m274[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [32m'Reason code: Canceled on conflict out to pivot 2676, during read.'[39m,
    hint: [32m'The transaction might succeed if retried.'[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'predicate.c'[39m,
    line: [32m'4832'[39m,
    routine: [32m'OnConflict_CheckForSerializationFailure'[39m
  },
  length: [33m274[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [32m'Reason code: Canceled on conflict out to pivot 2676, during read.'[39m,
  hint: [32m'The transaction might succeed if retried.'[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'predicate.c'[39m,
  line: [32m'4832'[39m,
  routine: [32m'OnConflict_CheckForSerializationFailure'[39m
}
[31m[Nest] 28082  - [39m16/01/2026, 9:42:44 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to read/write dependencies among transactions
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'df4f8f52-3261-4b18-b5b3-8094dd0ee34f'[39m,
    [32m'456e89a4-45c4-4407-9953-38c1adafcf82'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to read/write dependencies among transactions
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m274[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [32m'Reason code: Canceled on conflict out to pivot 2686, during read.'[39m,
    hint: [32m'The transaction might succeed if retried.'[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'predicate.c'[39m,
    line: [32m'4832'[39m,
    routine: [32m'OnConflict_CheckForSerializationFailure'[39m
  },
  length: [33m274[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [32m'Reason code: Canceled on conflict out to pivot 2686, during read.'[39m,
  hint: [32m'The transaction might succeed if retried.'[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'predicate.c'[39m,
  line: [32m'4832'[39m,
  routine: [32m'OnConflict_CheckForSerializationFailure'[39m
}
[31m[Nest] 28082  - [39m16/01/2026, 9:42:45 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to concurrent update
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'df4f8f52-3261-4b18-b5b3-8094dd0ee34f'[39m,
    [32m'456e89a4-45c4-4407-9953-38c1adafcf82'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to concurrent update
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m114[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'nodeLockRows.c'[39m,
    line: [32m'227'[39m,
    routine: [32m'ExecLockRows'[39m
  },
  length: [33m114[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'nodeLockRows.c'[39m,
  line: [32m'227'[39m,
  routine: [32m'ExecLockRows'[39m
}
[31m[Nest] 28082  - [39m16/01/2026, 9:42:45 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to concurrent update
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'df4f8f52-3261-4b18-b5b3-8094dd0ee34f'[39m,
    [32m'456e89a4-45c4-4407-9953-38c1adafcf82'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to concurrent update
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m114[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'nodeLockRows.c'[39m,
    line: [32m'227'[39m,
    routine: [32m'ExecLockRows'[39m
  },
  length: [33m114[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'nodeLockRows.c'[39m,
  line: [32m'227'[39m,
  routine: [32m'ExecLockRows'[39m
}
[31m[Nest] 28082  - [39m16/01/2026, 9:42:45 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to concurrent update
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'df4f8f52-3261-4b18-b5b3-8094dd0ee34f'[39m,
    [32m'456e89a4-45c4-4407-9953-38c1adafcf82'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to concurrent update
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m114[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'nodeLockRows.c'[39m,
    line: [32m'227'[39m,
    routine: [32m'ExecLockRows'[39m
  },
  length: [33m114[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'nodeLockRows.c'[39m,
  line: [32m'227'[39m,
  routine: [32m'ExecLockRows'[39m
}
[31m[Nest] 28082  - [39m16/01/2026, 9:42:45 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to concurrent update
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'df4f8f52-3261-4b18-b5b3-8094dd0ee34f'[39m,
    [32m'456e89a4-45c4-4407-9953-38c1adafcf82'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to concurrent update
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m114[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'nodeLockRows.c'[39m,
    line: [32m'227'[39m,
    routine: [32m'ExecLockRows'[39m
  },
  length: [33m114[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'nodeLockRows.c'[39m,
  line: [32m'227'[39m,
  routine: [32m'ExecLockRows'[39m
}
[31m[Nest] 28082  - [39m16/01/2026, 9:42:45 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to concurrent update
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'df4f8f52-3261-4b18-b5b3-8094dd0ee34f'[39m,
    [32m'456e89a4-45c4-4407-9953-38c1adafcf82'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to concurrent update
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m114[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'nodeLockRows.c'[39m,
    line: [32m'227'[39m,
    routine: [32m'ExecLockRows'[39m
  },
  length: [33m114[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'nodeLockRows.c'[39m,
  line: [32m'227'[39m,
  routine: [32m'ExecLockRows'[39m
}
[31m[Nest] 28082  - [39m16/01/2026, 9:42:45 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to concurrent update
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'df4f8f52-3261-4b18-b5b3-8094dd0ee34f'[39m,
    [32m'456e89a4-45c4-4407-9953-38c1adafcf82'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to concurrent update
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m114[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'nodeLockRows.c'[39m,
    line: [32m'227'[39m,
    routine: [32m'ExecLockRows'[39m
  },
  length: [33m114[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'nodeLockRows.c'[39m,
  line: [32m'227'[39m,
  routine: [32m'ExecLockRows'[39m
}
[31m[Nest] 28082  - [39m16/01/2026, 9:42:45 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to concurrent update
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'df4f8f52-3261-4b18-b5b3-8094dd0ee34f'[39m,
    [32m'456e89a4-45c4-4407-9953-38c1adafcf82'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to concurrent update
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m114[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'nodeLockRows.c'[39m,
    line: [32m'227'[39m,
    routine: [32m'ExecLockRows'[39m
  },
  length: [33m114[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'nodeLockRows.c'[39m,
  line: [32m'227'[39m,
  routine: [32m'ExecLockRows'[39m
}
[31m[Nest] 28082  - [39m16/01/2026, 9:42:45 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to read/write dependencies among transactions
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'df4f8f52-3261-4b18-b5b3-8094dd0ee34f'[39m,
    [32m'456e89a4-45c4-4407-9953-38c1adafcf82'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to read/write dependencies among transactions
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m274[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [32m'Reason code: Canceled on conflict out to pivot 2686, during read.'[39m,
    hint: [32m'The transaction might succeed if retried.'[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'predicate.c'[39m,
    line: [32m'4832'[39m,
    routine: [32m'OnConflict_CheckForSerializationFailure'[39m
  },
  length: [33m274[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [32m'Reason code: Canceled on conflict out to pivot 2686, during read.'[39m,
  hint: [32m'The transaction might succeed if retried.'[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'predicate.c'[39m,
  line: [32m'4832'[39m,
  routine: [32m'OnConflict_CheckForSerializationFailure'[39m
}
[31m[Nest] 28082  - [39m16/01/2026, 9:42:45 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to read/write dependencies among transactions
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'df4f8f52-3261-4b18-b5b3-8094dd0ee34f'[39m,
    [32m'456e89a4-45c4-4407-9953-38c1adafcf82'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to read/write dependencies among transactions
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m274[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [32m'Reason code: Canceled on conflict out to pivot 2686, during read.'[39m,
    hint: [32m'The transaction might succeed if retried.'[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'predicate.c'[39m,
    line: [32m'4832'[39m,
    routine: [32m'OnConflict_CheckForSerializationFailure'[39m
  },
  length: [33m274[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [32m'Reason code: Canceled on conflict out to pivot 2686, during read.'[39m,
  hint: [32m'The transaction might succeed if retried.'[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'predicate.c'[39m,
  line: [32m'4832'[39m,
  routine: [32m'OnConflict_CheckForSerializationFailure'[39m
}
[31m[Nest] 28082  - [39m16/01/2026, 9:42:45 p.¬†m. [31m  ERROR[39m [38;5;3m[ExceptionsHandler] [39mQueryFailedError: could not serialize access due to concurrent update
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
    at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
    at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
    at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
    at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'SELECT "InventoryLot"."id" AS "InventoryLot_id", "InventoryLot"."tenant_id" AS "InventoryLot_tenant_id", "InventoryLot"."lot_number" AS "InventoryLot_lot_number", "InventoryLot"."variant_id" AS "InventoryLot_variant_id", "InventoryLot"."purchase_invoice_id" AS "InventoryLot_purchase_invoice_id", "InventoryLot"."branch_id" AS "InventoryLot_branch_id", "InventoryLot"."initial_quantity" AS "InventoryLot_initial_quantity", "InventoryLot"."current_quantity" AS "InventoryLot_current_quantity", "InventoryLot"."purchase_price" AS "InventoryLot_purchase_price", "InventoryLot"."unit_cost" AS "InventoryLot_unit_cost", "InventoryLot"."production_date" AS "InventoryLot_production_date", "InventoryLot"."expiry_date" AS "InventoryLot_expiry_date", "InventoryLot"."status" AS "InventoryLot_status", "InventoryLot"."notes" AS "InventoryLot_notes", "InventoryLot"."created_at" AS "InventoryLot_created_at", "InventoryLot"."deleted_at" AS "InventoryLot_deleted_at" FROM "inventory_lots" "InventoryLot" WHERE ( (("InventoryLot"."variant_id" = $1) AND ("InventoryLot"."branch_id" = $2) AND ("InventoryLot"."status" = $3)) ) AND ( "InventoryLot"."deleted_at" IS NULL ) ORDER BY "InventoryLot"."expiry_date" ASC LIMIT 1 FOR UPDATE'[39m,
  parameters: [
    [32m'df4f8f52-3261-4b18-b5b3-8094dd0ee34f'[39m,
    [32m'456e89a4-45c4-4407-9953-38c1adafcf82'[39m,
    [32m'active'[39m
  ],
  driverError: error: could not serialize access due to concurrent update
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at SelectQueryBuilder.loadRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3868:25)
      at SelectQueryBuilder.executeEntitiesAndRawResults (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:3614:26)
      at SelectQueryBuilder.getRawAndEntities (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1671:29)
      at SelectQueryBuilder.getOne (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/SelectQueryBuilder.ts:1698:25)
      at SalesService.processSaleItem [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:153:17[90m)[39m
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.service.ts:67:11
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SalesController.createSale [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sales/sales.controller.ts:30:18[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m114[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'40001'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'nodeLockRows.c'[39m,
    line: [32m'227'[39m,
    routine: [32m'ExecLockRows'[39m
  },
  length: [33m114[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'40001'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'nodeLockRows.c'[39m,
  line: [32m'227'[39m,
  routine: [32m'ExecLockRows'[39m
}
PASS test/sales-concurrency.e2e-spec.ts
  ‚óè Console

    console.log
      [CreateSale] User: {
        userId: 'f886ffdf-262b-4947-ade7-b1225882555e',
        tenantId: 'f5475f4e-9743-4ac4-a1b5-55938b2dc6b9',
        email: 'conc-sales-1768617762640@test.com',
        roleId: '440da099-cf31-4c4d-a289-f114899a490c',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: f5475f4e-9743-4ac4-a1b5-55938b2dc6b9

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"456e89a4-45c4-4407-9953-38c1adafcf82","cashierId":"f886ffdf-262b-4947-ade7-b1225882555e","paymentMethod":"cash","items":[{"variantId":"df4f8f52-3261-4b18-b5b3-8094dd0ee34f","quantity":1,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'f886ffdf-262b-4947-ade7-b1225882555e',
        tenantId: 'f5475f4e-9743-4ac4-a1b5-55938b2dc6b9',
        email: 'conc-sales-1768617762640@test.com',
        roleId: '440da099-cf31-4c4d-a289-f114899a490c',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: f5475f4e-9743-4ac4-a1b5-55938b2dc6b9

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"456e89a4-45c4-4407-9953-38c1adafcf82","cashierId":"f886ffdf-262b-4947-ade7-b1225882555e","paymentMethod":"cash","items":[{"variantId":"df4f8f52-3261-4b18-b5b3-8094dd0ee34f","quantity":1,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'f886ffdf-262b-4947-ade7-b1225882555e',
        tenantId: 'f5475f4e-9743-4ac4-a1b5-55938b2dc6b9',
        email: 'conc-sales-1768617762640@test.com',
        roleId: '440da099-cf31-4c4d-a289-f114899a490c',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: f5475f4e-9743-4ac4-a1b5-55938b2dc6b9

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"456e89a4-45c4-4407-9953-38c1adafcf82","cashierId":"f886ffdf-262b-4947-ade7-b1225882555e","paymentMethod":"cash","items":[{"variantId":"df4f8f52-3261-4b18-b5b3-8094dd0ee34f","quantity":1,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'f886ffdf-262b-4947-ade7-b1225882555e',
        tenantId: 'f5475f4e-9743-4ac4-a1b5-55938b2dc6b9',
        email: 'conc-sales-1768617762640@test.com',
        roleId: '440da099-cf31-4c4d-a289-f114899a490c',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: f5475f4e-9743-4ac4-a1b5-55938b2dc6b9

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"456e89a4-45c4-4407-9953-38c1adafcf82","cashierId":"f886ffdf-262b-4947-ade7-b1225882555e","paymentMethod":"cash","items":[{"variantId":"df4f8f52-3261-4b18-b5b3-8094dd0ee34f","quantity":1,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'f886ffdf-262b-4947-ade7-b1225882555e',
        tenantId: 'f5475f4e-9743-4ac4-a1b5-55938b2dc6b9',
        email: 'conc-sales-1768617762640@test.com',
        roleId: '440da099-cf31-4c4d-a289-f114899a490c',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: f5475f4e-9743-4ac4-a1b5-55938b2dc6b9

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"456e89a4-45c4-4407-9953-38c1adafcf82","cashierId":"f886ffdf-262b-4947-ade7-b1225882555e","paymentMethod":"cash","items":[{"variantId":"df4f8f52-3261-4b18-b5b3-8094dd0ee34f","quantity":1,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'f886ffdf-262b-4947-ade7-b1225882555e',
        tenantId: 'f5475f4e-9743-4ac4-a1b5-55938b2dc6b9',
        email: 'conc-sales-1768617762640@test.com',
        roleId: '440da099-cf31-4c4d-a289-f114899a490c',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: f5475f4e-9743-4ac4-a1b5-55938b2dc6b9

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"456e89a4-45c4-4407-9953-38c1adafcf82","cashierId":"f886ffdf-262b-4947-ade7-b1225882555e","paymentMethod":"cash","items":[{"variantId":"df4f8f52-3261-4b18-b5b3-8094dd0ee34f","quantity":1,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'f886ffdf-262b-4947-ade7-b1225882555e',
        tenantId: 'f5475f4e-9743-4ac4-a1b5-55938b2dc6b9',
        email: 'conc-sales-1768617762640@test.com',
        roleId: '440da099-cf31-4c4d-a289-f114899a490c',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: f5475f4e-9743-4ac4-a1b5-55938b2dc6b9

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"456e89a4-45c4-4407-9953-38c1adafcf82","cashierId":"f886ffdf-262b-4947-ade7-b1225882555e","paymentMethod":"cash","items":[{"variantId":"df4f8f52-3261-4b18-b5b3-8094dd0ee34f","quantity":1,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'f886ffdf-262b-4947-ade7-b1225882555e',
        tenantId: 'f5475f4e-9743-4ac4-a1b5-55938b2dc6b9',
        email: 'conc-sales-1768617762640@test.com',
        roleId: '440da099-cf31-4c4d-a289-f114899a490c',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: f5475f4e-9743-4ac4-a1b5-55938b2dc6b9

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"456e89a4-45c4-4407-9953-38c1adafcf82","cashierId":"f886ffdf-262b-4947-ade7-b1225882555e","paymentMethod":"cash","items":[{"variantId":"df4f8f52-3261-4b18-b5b3-8094dd0ee34f","quantity":1,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'f886ffdf-262b-4947-ade7-b1225882555e',
        tenantId: 'f5475f4e-9743-4ac4-a1b5-55938b2dc6b9',
        email: 'conc-sales-1768617762640@test.com',
        roleId: '440da099-cf31-4c4d-a289-f114899a490c',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: f5475f4e-9743-4ac4-a1b5-55938b2dc6b9

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"456e89a4-45c4-4407-9953-38c1adafcf82","cashierId":"f886ffdf-262b-4947-ade7-b1225882555e","paymentMethod":"cash","items":[{"variantId":"df4f8f52-3261-4b18-b5b3-8094dd0ee34f","quantity":1,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'f886ffdf-262b-4947-ade7-b1225882555e',
        tenantId: 'f5475f4e-9743-4ac4-a1b5-55938b2dc6b9',
        email: 'conc-sales-1768617762640@test.com',
        roleId: '440da099-cf31-4c4d-a289-f114899a490c',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: f5475f4e-9743-4ac4-a1b5-55938b2dc6b9

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"456e89a4-45c4-4407-9953-38c1adafcf82","cashierId":"f886ffdf-262b-4947-ade7-b1225882555e","paymentMethod":"cash","items":[{"variantId":"df4f8f52-3261-4b18-b5b3-8094dd0ee34f","quantity":1,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["df4f8f52-3261-4b18-b5b3-8094dd0ee34f","456e89a4-45c4-4407-9953-38c1adafcf82","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to read/write dependencies among transactions

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["df4f8f52-3261-4b18-b5b3-8094dd0ee34f","456e89a4-45c4-4407-9953-38c1adafcf82","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to concurrent update

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["df4f8f52-3261-4b18-b5b3-8094dd0ee34f","456e89a4-45c4-4407-9953-38c1adafcf82","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to read/write dependencies among transactions

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["df4f8f52-3261-4b18-b5b3-8094dd0ee34f","456e89a4-45c4-4407-9953-38c1adafcf82","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to read/write dependencies among transactions

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["df4f8f52-3261-4b18-b5b3-8094dd0ee34f","456e89a4-45c4-4407-9953-38c1adafcf82","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to read/write dependencies among transactions

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["df4f8f52-3261-4b18-b5b3-8094dd0ee34f","456e89a4-45c4-4407-9953-38c1adafcf82","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to read/write dependencies among transactions

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["df4f8f52-3261-4b18-b5b3-8094dd0ee34f","456e89a4-45c4-4407-9953-38c1adafcf82","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to read/write dependencies among transactions

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["df4f8f52-3261-4b18-b5b3-8094dd0ee34f","456e89a4-45c4-4407-9953-38c1adafcf82","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to read/write dependencies among transactions

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["df4f8f52-3261-4b18-b5b3-8094dd0ee34f","456e89a4-45c4-4407-9953-38c1adafcf82","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to read/write dependencies among transactions

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [CreateSale] User: {
        userId: 'f886ffdf-262b-4947-ade7-b1225882555e',
        tenantId: 'f5475f4e-9743-4ac4-a1b5-55938b2dc6b9',
        email: 'conc-sales-1768617762640@test.com',
        roleId: '440da099-cf31-4c4d-a289-f114899a490c',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: f5475f4e-9743-4ac4-a1b5-55938b2dc6b9

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"456e89a4-45c4-4407-9953-38c1adafcf82","cashierId":"f886ffdf-262b-4947-ade7-b1225882555e","paymentMethod":"cash","items":[{"variantId":"df4f8f52-3261-4b18-b5b3-8094dd0ee34f","quantity":2,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'f886ffdf-262b-4947-ade7-b1225882555e',
        tenantId: 'f5475f4e-9743-4ac4-a1b5-55938b2dc6b9',
        email: 'conc-sales-1768617762640@test.com',
        roleId: '440da099-cf31-4c4d-a289-f114899a490c',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: f5475f4e-9743-4ac4-a1b5-55938b2dc6b9

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"456e89a4-45c4-4407-9953-38c1adafcf82","cashierId":"f886ffdf-262b-4947-ade7-b1225882555e","paymentMethod":"cash","items":[{"variantId":"df4f8f52-3261-4b18-b5b3-8094dd0ee34f","quantity":2,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'f886ffdf-262b-4947-ade7-b1225882555e',
        tenantId: 'f5475f4e-9743-4ac4-a1b5-55938b2dc6b9',
        email: 'conc-sales-1768617762640@test.com',
        roleId: '440da099-cf31-4c4d-a289-f114899a490c',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: f5475f4e-9743-4ac4-a1b5-55938b2dc6b9

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"456e89a4-45c4-4407-9953-38c1adafcf82","cashierId":"f886ffdf-262b-4947-ade7-b1225882555e","paymentMethod":"cash","items":[{"variantId":"df4f8f52-3261-4b18-b5b3-8094dd0ee34f","quantity":2,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'f886ffdf-262b-4947-ade7-b1225882555e',
        tenantId: 'f5475f4e-9743-4ac4-a1b5-55938b2dc6b9',
        email: 'conc-sales-1768617762640@test.com',
        roleId: '440da099-cf31-4c4d-a289-f114899a490c',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: f5475f4e-9743-4ac4-a1b5-55938b2dc6b9

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"456e89a4-45c4-4407-9953-38c1adafcf82","cashierId":"f886ffdf-262b-4947-ade7-b1225882555e","paymentMethod":"cash","items":[{"variantId":"df4f8f52-3261-4b18-b5b3-8094dd0ee34f","quantity":2,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'f886ffdf-262b-4947-ade7-b1225882555e',
        tenantId: 'f5475f4e-9743-4ac4-a1b5-55938b2dc6b9',
        email: 'conc-sales-1768617762640@test.com',
        roleId: '440da099-cf31-4c4d-a289-f114899a490c',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: f5475f4e-9743-4ac4-a1b5-55938b2dc6b9

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"456e89a4-45c4-4407-9953-38c1adafcf82","cashierId":"f886ffdf-262b-4947-ade7-b1225882555e","paymentMethod":"cash","items":[{"variantId":"df4f8f52-3261-4b18-b5b3-8094dd0ee34f","quantity":2,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'f886ffdf-262b-4947-ade7-b1225882555e',
        tenantId: 'f5475f4e-9743-4ac4-a1b5-55938b2dc6b9',
        email: 'conc-sales-1768617762640@test.com',
        roleId: '440da099-cf31-4c4d-a289-f114899a490c',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: f5475f4e-9743-4ac4-a1b5-55938b2dc6b9

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"456e89a4-45c4-4407-9953-38c1adafcf82","cashierId":"f886ffdf-262b-4947-ade7-b1225882555e","paymentMethod":"cash","items":[{"variantId":"df4f8f52-3261-4b18-b5b3-8094dd0ee34f","quantity":2,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'f886ffdf-262b-4947-ade7-b1225882555e',
        tenantId: 'f5475f4e-9743-4ac4-a1b5-55938b2dc6b9',
        email: 'conc-sales-1768617762640@test.com',
        roleId: '440da099-cf31-4c4d-a289-f114899a490c',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: f5475f4e-9743-4ac4-a1b5-55938b2dc6b9

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"456e89a4-45c4-4407-9953-38c1adafcf82","cashierId":"f886ffdf-262b-4947-ade7-b1225882555e","paymentMethod":"cash","items":[{"variantId":"df4f8f52-3261-4b18-b5b3-8094dd0ee34f","quantity":2,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'f886ffdf-262b-4947-ade7-b1225882555e',
        tenantId: 'f5475f4e-9743-4ac4-a1b5-55938b2dc6b9',
        email: 'conc-sales-1768617762640@test.com',
        roleId: '440da099-cf31-4c4d-a289-f114899a490c',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: f5475f4e-9743-4ac4-a1b5-55938b2dc6b9

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"456e89a4-45c4-4407-9953-38c1adafcf82","cashierId":"f886ffdf-262b-4947-ade7-b1225882555e","paymentMethod":"cash","items":[{"variantId":"df4f8f52-3261-4b18-b5b3-8094dd0ee34f","quantity":2,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'f886ffdf-262b-4947-ade7-b1225882555e',
        tenantId: 'f5475f4e-9743-4ac4-a1b5-55938b2dc6b9',
        email: 'conc-sales-1768617762640@test.com',
        roleId: '440da099-cf31-4c4d-a289-f114899a490c',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: f5475f4e-9743-4ac4-a1b5-55938b2dc6b9

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"456e89a4-45c4-4407-9953-38c1adafcf82","cashierId":"f886ffdf-262b-4947-ade7-b1225882555e","paymentMethod":"cash","items":[{"variantId":"df4f8f52-3261-4b18-b5b3-8094dd0ee34f","quantity":2,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'f886ffdf-262b-4947-ade7-b1225882555e',
        tenantId: 'f5475f4e-9743-4ac4-a1b5-55938b2dc6b9',
        email: 'conc-sales-1768617762640@test.com',
        roleId: '440da099-cf31-4c4d-a289-f114899a490c',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: f5475f4e-9743-4ac4-a1b5-55938b2dc6b9

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"456e89a4-45c4-4407-9953-38c1adafcf82","cashierId":"f886ffdf-262b-4947-ade7-b1225882555e","paymentMethod":"cash","items":[{"variantId":"df4f8f52-3261-4b18-b5b3-8094dd0ee34f","quantity":2,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'f886ffdf-262b-4947-ade7-b1225882555e',
        tenantId: 'f5475f4e-9743-4ac4-a1b5-55938b2dc6b9',
        email: 'conc-sales-1768617762640@test.com',
        roleId: '440da099-cf31-4c4d-a289-f114899a490c',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: f5475f4e-9743-4ac4-a1b5-55938b2dc6b9

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"456e89a4-45c4-4407-9953-38c1adafcf82","cashierId":"f886ffdf-262b-4947-ade7-b1225882555e","paymentMethod":"cash","items":[{"variantId":"df4f8f52-3261-4b18-b5b3-8094dd0ee34f","quantity":2,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'f886ffdf-262b-4947-ade7-b1225882555e',
        tenantId: 'f5475f4e-9743-4ac4-a1b5-55938b2dc6b9',
        email: 'conc-sales-1768617762640@test.com',
        roleId: '440da099-cf31-4c4d-a289-f114899a490c',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: f5475f4e-9743-4ac4-a1b5-55938b2dc6b9

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"456e89a4-45c4-4407-9953-38c1adafcf82","cashierId":"f886ffdf-262b-4947-ade7-b1225882555e","paymentMethod":"cash","items":[{"variantId":"df4f8f52-3261-4b18-b5b3-8094dd0ee34f","quantity":2,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'f886ffdf-262b-4947-ade7-b1225882555e',
        tenantId: 'f5475f4e-9743-4ac4-a1b5-55938b2dc6b9',
        email: 'conc-sales-1768617762640@test.com',
        roleId: '440da099-cf31-4c4d-a289-f114899a490c',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: f5475f4e-9743-4ac4-a1b5-55938b2dc6b9

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"456e89a4-45c4-4407-9953-38c1adafcf82","cashierId":"f886ffdf-262b-4947-ade7-b1225882555e","paymentMethod":"cash","items":[{"variantId":"df4f8f52-3261-4b18-b5b3-8094dd0ee34f","quantity":2,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'f886ffdf-262b-4947-ade7-b1225882555e',
        tenantId: 'f5475f4e-9743-4ac4-a1b5-55938b2dc6b9',
        email: 'conc-sales-1768617762640@test.com',
        roleId: '440da099-cf31-4c4d-a289-f114899a490c',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: f5475f4e-9743-4ac4-a1b5-55938b2dc6b9

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"456e89a4-45c4-4407-9953-38c1adafcf82","cashierId":"f886ffdf-262b-4947-ade7-b1225882555e","paymentMethod":"cash","items":[{"variantId":"df4f8f52-3261-4b18-b5b3-8094dd0ee34f","quantity":2,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'f886ffdf-262b-4947-ade7-b1225882555e',
        tenantId: 'f5475f4e-9743-4ac4-a1b5-55938b2dc6b9',
        email: 'conc-sales-1768617762640@test.com',
        roleId: '440da099-cf31-4c4d-a289-f114899a490c',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: f5475f4e-9743-4ac4-a1b5-55938b2dc6b9

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"456e89a4-45c4-4407-9953-38c1adafcf82","cashierId":"f886ffdf-262b-4947-ade7-b1225882555e","paymentMethod":"cash","items":[{"variantId":"df4f8f52-3261-4b18-b5b3-8094dd0ee34f","quantity":2,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'f886ffdf-262b-4947-ade7-b1225882555e',
        tenantId: 'f5475f4e-9743-4ac4-a1b5-55938b2dc6b9',
        email: 'conc-sales-1768617762640@test.com',
        roleId: '440da099-cf31-4c4d-a289-f114899a490c',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: f5475f4e-9743-4ac4-a1b5-55938b2dc6b9

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"456e89a4-45c4-4407-9953-38c1adafcf82","cashierId":"f886ffdf-262b-4947-ade7-b1225882555e","paymentMethod":"cash","items":[{"variantId":"df4f8f52-3261-4b18-b5b3-8094dd0ee34f","quantity":2,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["df4f8f52-3261-4b18-b5b3-8094dd0ee34f","456e89a4-45c4-4407-9953-38c1adafcf82","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to read/write dependencies among transactions

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [CreateSale] User: {
        userId: 'f886ffdf-262b-4947-ade7-b1225882555e',
        tenantId: 'f5475f4e-9743-4ac4-a1b5-55938b2dc6b9',
        email: 'conc-sales-1768617762640@test.com',
        roleId: '440da099-cf31-4c4d-a289-f114899a490c',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: f5475f4e-9743-4ac4-a1b5-55938b2dc6b9

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"456e89a4-45c4-4407-9953-38c1adafcf82","cashierId":"f886ffdf-262b-4947-ade7-b1225882555e","paymentMethod":"cash","items":[{"variantId":"df4f8f52-3261-4b18-b5b3-8094dd0ee34f","quantity":2,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["df4f8f52-3261-4b18-b5b3-8094dd0ee34f","456e89a4-45c4-4407-9953-38c1adafcf82","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to concurrent update

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["df4f8f52-3261-4b18-b5b3-8094dd0ee34f","456e89a4-45c4-4407-9953-38c1adafcf82","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to concurrent update

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["df4f8f52-3261-4b18-b5b3-8094dd0ee34f","456e89a4-45c4-4407-9953-38c1adafcf82","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to concurrent update

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["df4f8f52-3261-4b18-b5b3-8094dd0ee34f","456e89a4-45c4-4407-9953-38c1adafcf82","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to concurrent update

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["df4f8f52-3261-4b18-b5b3-8094dd0ee34f","456e89a4-45c4-4407-9953-38c1adafcf82","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to concurrent update

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["df4f8f52-3261-4b18-b5b3-8094dd0ee34f","456e89a4-45c4-4407-9953-38c1adafcf82","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to concurrent update

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["df4f8f52-3261-4b18-b5b3-8094dd0ee34f","456e89a4-45c4-4407-9953-38c1adafcf82","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to concurrent update

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [CreateSale] User: {
        userId: 'f886ffdf-262b-4947-ade7-b1225882555e',
        tenantId: 'f5475f4e-9743-4ac4-a1b5-55938b2dc6b9',
        email: 'conc-sales-1768617762640@test.com',
        roleId: '440da099-cf31-4c4d-a289-f114899a490c',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: f5475f4e-9743-4ac4-a1b5-55938b2dc6b9

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"456e89a4-45c4-4407-9953-38c1adafcf82","cashierId":"f886ffdf-262b-4947-ade7-b1225882555e","paymentMethod":"cash","items":[{"variantId":"df4f8f52-3261-4b18-b5b3-8094dd0ee34f","quantity":2,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["df4f8f52-3261-4b18-b5b3-8094dd0ee34f","456e89a4-45c4-4407-9953-38c1adafcf82","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to read/write dependencies among transactions

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [CreateSale] User: {
        userId: 'f886ffdf-262b-4947-ade7-b1225882555e',
        tenantId: 'f5475f4e-9743-4ac4-a1b5-55938b2dc6b9',
        email: 'conc-sales-1768617762640@test.com',
        roleId: '440da099-cf31-4c4d-a289-f114899a490c',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: f5475f4e-9743-4ac4-a1b5-55938b2dc6b9

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"456e89a4-45c4-4407-9953-38c1adafcf82","cashierId":"f886ffdf-262b-4947-ade7-b1225882555e","paymentMethod":"cash","items":[{"variantId":"df4f8f52-3261-4b18-b5b3-8094dd0ee34f","quantity":2,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'f886ffdf-262b-4947-ade7-b1225882555e',
        tenantId: 'f5475f4e-9743-4ac4-a1b5-55938b2dc6b9',
        email: 'conc-sales-1768617762640@test.com',
        roleId: '440da099-cf31-4c4d-a289-f114899a490c',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: f5475f4e-9743-4ac4-a1b5-55938b2dc6b9

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"456e89a4-45c4-4407-9953-38c1adafcf82","cashierId":"f886ffdf-262b-4947-ade7-b1225882555e","paymentMethod":"cash","items":[{"variantId":"df4f8f52-3261-4b18-b5b3-8094dd0ee34f","quantity":2,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'f886ffdf-262b-4947-ade7-b1225882555e',
        tenantId: 'f5475f4e-9743-4ac4-a1b5-55938b2dc6b9',
        email: 'conc-sales-1768617762640@test.com',
        roleId: '440da099-cf31-4c4d-a289-f114899a490c',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: f5475f4e-9743-4ac4-a1b5-55938b2dc6b9

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"456e89a4-45c4-4407-9953-38c1adafcf82","cashierId":"f886ffdf-262b-4947-ade7-b1225882555e","paymentMethod":"cash","items":[{"variantId":"df4f8f52-3261-4b18-b5b3-8094dd0ee34f","quantity":2,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["df4f8f52-3261-4b18-b5b3-8094dd0ee34f","456e89a4-45c4-4407-9953-38c1adafcf82","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to read/write dependencies among transactions

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["df4f8f52-3261-4b18-b5b3-8094dd0ee34f","456e89a4-45c4-4407-9953-38c1adafcf82","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to concurrent update

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["df4f8f52-3261-4b18-b5b3-8094dd0ee34f","456e89a4-45c4-4407-9953-38c1adafcf82","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to concurrent update

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["df4f8f52-3261-4b18-b5b3-8094dd0ee34f","456e89a4-45c4-4407-9953-38c1adafcf82","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to concurrent update

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["df4f8f52-3261-4b18-b5b3-8094dd0ee34f","456e89a4-45c4-4407-9953-38c1adafcf82","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to concurrent update

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["df4f8f52-3261-4b18-b5b3-8094dd0ee34f","456e89a4-45c4-4407-9953-38c1adafcf82","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to concurrent update

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["df4f8f52-3261-4b18-b5b3-8094dd0ee34f","456e89a4-45c4-4407-9953-38c1adafcf82","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to concurrent update

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["df4f8f52-3261-4b18-b5b3-8094dd0ee34f","456e89a4-45c4-4407-9953-38c1adafcf82","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to concurrent update

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["df4f8f52-3261-4b18-b5b3-8094dd0ee34f","456e89a4-45c4-4407-9953-38c1adafcf82","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to read/write dependencies among transactions

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["df4f8f52-3261-4b18-b5b3-8094dd0ee34f","456e89a4-45c4-4407-9953-38c1adafcf82","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to read/write dependencies among transactions

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [CreateSale] User: {
        userId: 'f886ffdf-262b-4947-ade7-b1225882555e',
        tenantId: 'f5475f4e-9743-4ac4-a1b5-55938b2dc6b9',
        email: 'conc-sales-1768617762640@test.com',
        roleId: '440da099-cf31-4c4d-a289-f114899a490c',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: f5475f4e-9743-4ac4-a1b5-55938b2dc6b9

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"456e89a4-45c4-4407-9953-38c1adafcf82","cashierId":"f886ffdf-262b-4947-ade7-b1225882555e","paymentMethod":"cash","items":[{"variantId":"df4f8f52-3261-4b18-b5b3-8094dd0ee34f","quantity":1,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'f886ffdf-262b-4947-ade7-b1225882555e',
        tenantId: 'f5475f4e-9743-4ac4-a1b5-55938b2dc6b9',
        email: 'conc-sales-1768617762640@test.com',
        roleId: '440da099-cf31-4c4d-a289-f114899a490c',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: f5475f4e-9743-4ac4-a1b5-55938b2dc6b9

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"456e89a4-45c4-4407-9953-38c1adafcf82","cashierId":"f886ffdf-262b-4947-ade7-b1225882555e","paymentMethod":"cash","items":[{"variantId":"df4f8f52-3261-4b18-b5b3-8094dd0ee34f","quantity":1,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [4m[31mquery failed:[39m[24m [94mSELECT[0m [37m"InventoryLot"[0m[37m.[0m[37m"id"[0m [94mAS[0m [37m"InventoryLot_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"tenant_id"[0m [94mAS[0m [37m"InventoryLot_tenant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"lot_number"[0m [94mAS[0m [37m"InventoryLot_lot_number"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [94mAS[0m [37m"InventoryLot_variant_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_invoice_id"[0m [94mAS[0m [37m"InventoryLot_purchase_invoice_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [94mAS[0m [37m"InventoryLot_branch_id"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"initial_quantity"[0m [94mAS[0m [37m"InventoryLot_initial_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"current_quantity"[0m [94mAS[0m [37m"InventoryLot_current_quantity"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"purchase_price"[0m [94mAS[0m [37m"InventoryLot_purchase_price"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"unit_cost"[0m [94mAS[0m [37m"InventoryLot_unit_cost"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"production_date"[0m [94mAS[0m [37m"InventoryLot_production_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mAS[0m [37m"InventoryLot_expiry_date"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [94mAS[0m [37m"InventoryLot_status"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"notes"[0m [94mAS[0m [37m"InventoryLot_notes"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"created_at"[0m [94mAS[0m [37m"InventoryLot_created_at"[0m[37m,[0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mAS[0m [37m"InventoryLot_deleted_at"[0m [94mFROM[0m [37m"inventory_lots"[0m [37m"InventoryLot"[0m [94mWHERE[0m [37m([0m [37m([0m[37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"variant_id"[0m [37m=[0m [37m$[0m[32m1[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"branch_id"[0m [37m=[0m [37m$[0m[32m2[0m[37m)[0m [94mAND[0m [37m([0m[37m"InventoryLot"[0m[37m.[0m[37m"status"[0m [37m=[0m [37m$[0m[32m3[0m[37m)[0m[37m)[0m [37m)[0m [94mAND[0m [37m([0m [37m"InventoryLot"[0m[37m.[0m[37m"deleted_at"[0m [94mIS NULL[0m [37m)[0m [94mORDER BY[0m [37m"InventoryLot"[0m[37m.[0m[37m"expiry_date"[0m [94mASC[0m [94mLIMIT[0m [32m1[0m [94mFOR[0m [94mUPDATE[0m [90m-- PARAMETERS: ["df4f8f52-3261-4b18-b5b3-8094dd0ee34f","456e89a4-45c4-4407-9953-38c1adafcf82","active"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: could not serialize access due to concurrent update

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [CreateSale] User: {
        userId: 'f886ffdf-262b-4947-ade7-b1225882555e',
        tenantId: 'f5475f4e-9743-4ac4-a1b5-55938b2dc6b9',
        email: 'conc-sales-1768617762640@test.com',
        roleId: '440da099-cf31-4c4d-a289-f114899a490c',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: f5475f4e-9743-4ac4-a1b5-55938b2dc6b9

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"456e89a4-45c4-4407-9953-38c1adafcf82","cashierId":"f886ffdf-262b-4947-ade7-b1225882555e","paymentMethod":"cash","items":[{"variantId":"df4f8f52-3261-4b18-b5b3-8094dd0ee34f","quantity":3,"unitPrice":100},{"variantId":"99999999-9999-9999-9999-999999999999","quantity":1,"unitPrice":50}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'f886ffdf-262b-4947-ade7-b1225882555e',
        tenantId: 'f5475f4e-9743-4ac4-a1b5-55938b2dc6b9',
        email: 'conc-sales-1768617762640@test.com',
        roleId: '440da099-cf31-4c4d-a289-f114899a490c',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: f5475f4e-9743-4ac4-a1b5-55938b2dc6b9

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"456e89a4-45c4-4407-9953-38c1adafcf82","cashierId":"f886ffdf-262b-4947-ade7-b1225882555e","paymentMethod":"cash","items":[{"variantId":"df4f8f52-3261-4b18-b5b3-8094dd0ee34f","quantity":999999,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'f886ffdf-262b-4947-ade7-b1225882555e',
        tenantId: 'f5475f4e-9743-4ac4-a1b5-55938b2dc6b9',
        email: 'conc-sales-1768617762640@test.com',
        roleId: '440da099-cf31-4c4d-a289-f114899a490c',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: f5475f4e-9743-4ac4-a1b5-55938b2dc6b9

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"456e89a4-45c4-4407-9953-38c1adafcf82","cashierId":"f886ffdf-262b-4947-ade7-b1225882555e","paymentMethod":"cash","items":[{"variantId":"df4f8f52-3261-4b18-b5b3-8094dd0ee34f","quantity":3,"unitPrice":100}]}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

PASS test/stock-validation.e2e-spec.ts
  ‚óè Console

    console.log
      [CreateSale] User: {
        userId: 'b27d793b-871d-40c2-9c43-8bd798b15303',
        tenantId: '96fc8d27-2197-4004-8cf7-0f81ff4a094b',
        email: 'stock-user-1768617767363@test.com',
        roleId: 'a065d98f-7a28-4764-bbed-aa99aa9b402e',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: 96fc8d27-2197-4004-8cf7-0f81ff4a094b

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"0658f817-1432-4aff-be88-a2fac948ba64","cashierId":"b27d793b-871d-40c2-9c43-8bd798b15303","items":[{"variantId":"613d6bc1-8ede-44d2-972c-65c4704bc175","quantity":5,"unitPrice":100}],"paymentMethod":"cash"}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'b27d793b-871d-40c2-9c43-8bd798b15303',
        tenantId: '96fc8d27-2197-4004-8cf7-0f81ff4a094b',
        email: 'stock-user-1768617767363@test.com',
        roleId: 'a065d98f-7a28-4764-bbed-aa99aa9b402e',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: 96fc8d27-2197-4004-8cf7-0f81ff4a094b

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"0658f817-1432-4aff-be88-a2fac948ba64","cashierId":"b27d793b-871d-40c2-9c43-8bd798b15303","items":[{"variantId":"613d6bc1-8ede-44d2-972c-65c4704bc175","quantity":3,"unitPrice":100}],"paymentMethod":"cash"}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

[31m[Nest] 28082  - [39m16/01/2026, 9:42:52 p.¬†m. [31m  ERROR[39m [38;5;3m[SyncService] [39m[31mFailed to sync cash session 1df17ed3-fbad-4f37-8f6a-6e3104281944[39m
[31m[Nest] 28082  - [39m16/01/2026, 9:42:52 p.¬†m. [31m  ERROR[39m [38;5;3m[SyncService] [39mQueryFailedError: insert or update on table "cash_sessions" violates foreign key constraint "cash_sessions_cash_register_id_fkey"
    at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:325:19)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at InsertQueryBuilder.execute (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/InsertQueryBuilder.ts:164:33)
    at SubjectExecutor.executeInsertOperations (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/persistence/SubjectExecutor.ts:435:42)
    at SubjectExecutor.execute (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/persistence/SubjectExecutor.ts:137:9)
    at EntityPersistExecutor.execute (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/persistence/EntityPersistExecutor.ts:182:21)
    at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sync/sync.service.ts:162:17
    at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
    at SyncService.processOfflineCashSession [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sync/sync.service.ts:120:9[90m)[39m
    at SyncService.pushBatch [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sync/sync.service.ts:45:21[90m)[39m
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
    at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
  query: [32m'INSERT INTO "cash_sessions"("id", "tenant_id", "cash_register_id", "user_id", "opening_date", "closing_date", "initial_amount", "system_amount", "declared_amount", "difference_justification", "status", "approved_by", "approved_at", "approval_notes", "created_at", "updated_at") VALUES ($1, $2, $3, $4, $5, DEFAULT, $6, $7, DEFAULT, DEFAULT, $8, DEFAULT, DEFAULT, DEFAULT, $9, $10) RETURNING "id", "opening_date", "initial_amount", "system_amount", "status", "created_at", "updated_at"'[39m,
  parameters: [
    [32m'1df17ed3-fbad-4f37-8f6a-6e3104281944'[39m,
    [32m'4ac29b66-5486-4336-9de5-e771d02d71dd'[39m,
    [32m'3995489a-553b-48bb-9c2e-b06044dc4d85'[39m,
    [32m'628e5d87-2455-4736-ad15-df63b4637f21'[39m,
    [35m2026-01-17T02:42:52.503Z[39m,
    [33m10000[39m,
    [33m10000[39m,
    [32m'open'[39m,
    [35m2026-01-17T02:42:52.503Z[39m,
    [35m2026-01-17T02:42:52.503Z[39m
  ],
  driverError: error: insert or update on table "cash_sessions" violates foreign key constraint "cash_sessions_cash_register_id_fkey"
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/pg@8.16.3/node_modules/[4mpg[24m/lib/client.js:545:17
  [90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
      at PostgresQueryRunner.query (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/driver/postgres/PostgresQueryRunner.ts:254:25)
      at InsertQueryBuilder.execute (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/query-builder/InsertQueryBuilder.ts:164:33)
      at SubjectExecutor.executeInsertOperations (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/persistence/SubjectExecutor.ts:435:42)
      at SubjectExecutor.execute (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/persistence/SubjectExecutor.ts:137:9)
      at EntityPersistExecutor.execute (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/persistence/EntityPersistExecutor.ts:182:21)
      at [90m/home/devin/Projects/qflow-pro/apps/api/[39msrc/sync/sync.service.ts:162:17
      at EntityManager.transaction (/home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/entity-manager/EntityManager.ts:156:28)
      at SyncService.processOfflineCashSession [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sync/sync.service.ts:120:9[90m)[39m
      at SyncService.pushBatch [90m(/home/devin/Projects/qflow-pro/apps/api/[39msrc/sync/sync.service.ts:45:21[90m)[39m
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-execution-context.js:46:28
      at /home/devin/Projects/qflow-pro/node_modules/[4m.pnpm[24m/@nestjs+core@11.1.11_@nestjs+common@11.1.11_class-transformer@0.5.1_class-validator@0.1_f21698ce7579297634c2f3d29d9e4f76/node_modules/[4m@nestjs[24m/core/router/router-proxy.js:9:17 {
    length: [33m345[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23503'[39m,
    detail: [32m'Key (cash_register_id)=(3995489a-553b-48bb-9c2e-b06044dc4d85) is not present in table "cash_registers".'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'public'[39m,
    table: [32m'cash_sessions'[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [32m'cash_sessions_cash_register_id_fkey'[39m,
    file: [32m'ri_triggers.c'[39m,
    line: [32m'2596'[39m,
    routine: [32m'ri_ReportViolation'[39m
  },
  length: [33m345[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'23503'[39m,
  detail: [32m'Key (cash_register_id)=(3995489a-553b-48bb-9c2e-b06044dc4d85) is not present in table "cash_registers".'[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [32m'public'[39m,
  table: [32m'cash_sessions'[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [32m'cash_sessions_cash_register_id_fkey'[39m,
  file: [32m'ri_triggers.c'[39m,
  line: [32m'2596'[39m,
  routine: [32m'ri_ReportViolation'[39m
}
PASS test/sync-batch.e2e-spec.ts
  ‚óè Console

    console.log
      [4m[31mquery failed:[39m[24m [94mINSERT INTO[0m [37m"cash_sessions"[0m[37m([0m[37m"id"[0m[37m,[0m [37m"tenant_id"[0m[37m,[0m [37m"cash_register_id"[0m[37m,[0m [37m"user_id"[0m[37m,[0m [37m"opening_date"[0m[37m,[0m [37m"closing_date"[0m[37m,[0m [37m"initial_amount"[0m[37m,[0m [37m"system_amount"[0m[37m,[0m [37m"declared_amount"[0m[37m,[0m [37m"difference_justification"[0m[37m,[0m [37m"status"[0m[37m,[0m [37m"approved_by"[0m[37m,[0m [37m"approved_at"[0m[37m,[0m [37m"approval_notes"[0m[37m,[0m [37m"created_at"[0m[37m,[0m [37m"updated_at"[0m[37m)[0m [94mVALUES[0m [37m([0m[37m$[0m[32m1[0m[37m,[0m [37m$[0m[32m2[0m[37m,[0m [37m$[0m[32m3[0m[37m,[0m [37m$[0m[32m4[0m[37m,[0m [37m$[0m[32m5[0m[37m,[0m [94mDEFAULT[0m[37m,[0m [37m$[0m[32m6[0m[37m,[0m [37m$[0m[32m7[0m[37m,[0m [94mDEFAULT[0m[37m,[0m [94mDEFAULT[0m[37m,[0m [37m$[0m[32m8[0m[37m,[0m [94mDEFAULT[0m[37m,[0m [94mDEFAULT[0m[37m,[0m [94mDEFAULT[0m[37m,[0m [37m$[0m[32m9[0m[37m,[0m [37m$[0m[32m10[0m[37m)[0m [94mRETURNING[0m [37m"id"[0m[37m,[0m [37m"opening_date"[0m[37m,[0m [37m"initial_amount"[0m[37m,[0m [37m"system_amount"[0m[37m,[0m [37m"status"[0m[37m,[0m [37m"created_at"[0m[37m,[0m [37m"updated_at"[0m [90m-- PARAMETERS: ["1df17ed3-fbad-4f37-8f6a-6e3104281944","4ac29b66-5486-4336-9de5-e771d02d71dd","3995489a-553b-48bb-9c2e-b06044dc4d85","628e5d87-2455-4736-ad15-df63b4637f21","2026-01-17T02:42:52.503Z",10000,10000,"open","2026-01-17T02:42:52.503Z","2026-01-17T02:42:52.503Z"][0m

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

    console.log
      [4m[31merror:[39m[24m error: insert or update on table "cash_sessions" violates foreign key constraint "cash_sessions_cash_register_id_fkey"

      at Function.logError (../../../node_modules/.pnpm/typeorm@0.3.28_pg@8.16.3_ts-node@10.9.2_@types+node@22.19.6_typescript@5.9.3_/src/platform/PlatformTools.ts:266:17)

PASS test/catalog.e2e-spec.ts
PASS test/sales.e2e-spec.ts
  ‚óè Console

    console.log
      [CreateSale] User: {
        userId: 'a5eb92fa-8e1d-41d6-a1df-3de5e286cc8b',
        tenantId: 'c9ad7ca3-2d93-456e-9994-b3fda70b6ce4',
        email: 'sales-test-1768617776447@test.com',
        roleId: '05280a3d-73d0-40dc-b854-5a332a8438d8',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: c9ad7ca3-2d93-456e-9994-b3fda70b6ce4

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"6b484af6-2bb3-404c-bdce-c464887cb5f4","cashierId":"a5eb92fa-8e1d-41d6-a1df-3de5e286cc8b","items":[{"variantId":"39a77e95-5937-4db9-aa71-495695160e19","quantity":2,"unitPrice":10000}],"paymentMethod":"cash","discountAmount":0}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'a5eb92fa-8e1d-41d6-a1df-3de5e286cc8b',
        tenantId: 'c9ad7ca3-2d93-456e-9994-b3fda70b6ce4',
        email: 'sales-test-1768617776447@test.com',
        roleId: '05280a3d-73d0-40dc-b854-5a332a8438d8',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: c9ad7ca3-2d93-456e-9994-b3fda70b6ce4

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"6b484af6-2bb3-404c-bdce-c464887cb5f4","cashierId":"a5eb92fa-8e1d-41d6-a1df-3de5e286cc8b","items":[{"variantId":"39a77e95-5937-4db9-aa71-495695160e19","quantity":10000,"unitPrice":10000}],"paymentMethod":"cash","discountAmount":0}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'a5eb92fa-8e1d-41d6-a1df-3de5e286cc8b',
        tenantId: 'c9ad7ca3-2d93-456e-9994-b3fda70b6ce4',
        email: 'sales-test-1768617776447@test.com',
        roleId: '05280a3d-73d0-40dc-b854-5a332a8438d8',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: c9ad7ca3-2d93-456e-9994-b3fda70b6ce4

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"6b484af6-2bb3-404c-bdce-c464887cb5f4","cashierId":"a5eb92fa-8e1d-41d6-a1df-3de5e286cc8b","items":[{"variantId":"8e64ebc4-0d90-4046-8949-812a84a702e8","quantity":1,"unitPrice":10000}],"paymentMethod":"cash","discountAmount":0}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

    console.log
      [CreateSale] User: {
        userId: 'a5eb92fa-8e1d-41d6-a1df-3de5e286cc8b',
        tenantId: 'c9ad7ca3-2d93-456e-9994-b3fda70b6ce4',
        email: 'sales-test-1768617776447@test.com',
        roleId: '05280a3d-73d0-40dc-b854-5a332a8438d8',
        branchIds: []
      }

      at SalesController.createSale (../src/sales/sales.controller.ts:27:13)

    console.log
      [CreateSale] TenantID: c9ad7ca3-2d93-456e-9994-b3fda70b6ce4

      at SalesController.createSale (../src/sales/sales.controller.ts:28:13)

    console.log
      [CreateSale] DTO: {"branchId":"6b484af6-2bb3-404c-bdce-c464887cb5f4","cashierId":"a5eb92fa-8e1d-41d6-a1df-3de5e286cc8b","items":[{"variantId":"39a77e95-5937-4db9-aa71-495695160e19","quantity":1,"unitPrice":10000,"discountPercent":10}],"paymentMethod":"cash","discountAmount":1000}

      at SalesController.createSale (../src/sales/sales.controller.ts:29:13)

PASS test/inventory.e2e-spec.ts
PASS test/auth-security.e2e-spec.ts
PASS test/app.e2e-spec.ts

Test Suites: 12 passed, 12 total
Tests:       88 passed, 88 total
Snapshots:   0 total
Time:        50.544 s, estimated 53 s
Ran all test suites.
Jest did not exit one second after the test run has completed.

'This usually means that there are asynchronous operations that weren't stopped in your tests. Consider running Jest with `--detectOpenHandles` to troubleshoot this issue.
